{% extends "layout.html" %}
{% from "_pagination.html" import render_pagination %}
{% block body %}

<div class="row">
  <div class="col-md-8">
    <h1>Tag: <span class="badge bg-primary" style="font-size: inherit;">{{ tag.name }}</span></h1>
    <p class="lead">{{ photo_count }} photo(s)</p>
  </div>
  <div class="col-md-4 text-end">
    {% if can_manage %}
    <div class="btn-group btn-group-sm">
      <button type="button" class="btn btn-link" data-bs-toggle="modal" data-bs-target="#renameTagModal">
        <span class="bi bi-pencil-fill"></span> rename
      </button>
      <button type="button" class="btn btn-link" data-bs-toggle="modal" data-bs-target="#mergeTagModal">
        <span class="bi bi-shuffle"></span> merge
      </button>
      <a href="{{SITEURL}}/photos/bulk-edit?ids={{ photo_ids }}" class="btn btn-link">
        <span class="bi bi-grid-3x3-gap"></span> bulk edit
      </a>
      <a href="{{SITEURL}}/tags/{{ tag.name }}/delete" class="btn btn-link text-danger"
         onclick="return confirm('Delete tag &quot;{{ tag.name }}&quot;? This will remove it from {{ photo_count }} photos.');">
        <span class="bi bi-trash-fill"></span> delete
      </a>
    </div>
    {% endif %}
  </div>
</div>
<hr>


<!-- Photo Grid -->
<div class="justified-gallery" id="photo-grid">
  {% for photo in photos %}
  <a href="{{SITEURL}}/photos/{{ photo.id }}?context={{ context }}" class="jg-item">
    <img class="lazy jg-photo"
         data-src="http://s3.amazonaws.com/{{ config['S3_BUCKET_NAME'] }}/{{ photo.uri }}_c.jpg"
         src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='320' height='240'%3E%3Crect fill='%23eee' width='320' height='240'/%3E%3C/svg%3E"
         alt="Photo {{ photo.id }}">
  </a>
  {% else %}
  <p class="text-muted">No photos with this tag.</p>
  {% endfor %}
</div>


<!-- Pagination -->
{{ render_pagination(pagination, baseurl) }}

<script>
// Lazy load images
document.addEventListener('DOMContentLoaded', function() {
  var lazyImages = document.querySelectorAll('img.lazy');

  if ('IntersectionObserver' in window) {
    var imageObserver = new IntersectionObserver(function(entries, observer) {
      entries.forEach(function(entry) {
        if (entry.isIntersecting) {
          var img = entry.target;
          img.src = img.dataset.src;
          img.classList.remove('lazy');
          imageObserver.unobserve(img);
        }
      });
    }, {
      rootMargin: '200px'
    });

    lazyImages.forEach(function(img) {
      imageObserver.observe(img);
    });
  } else {
    // Fallback for older browsers
    lazyImages.forEach(function(img) {
      img.src = img.dataset.src;
    });
  }
});
</script>


{% if can_manage %}
<!-- Rename Tag Modal -->
<div class="modal fade" id="renameTagModal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-sm" role="document">
    <div class="modal-content">
      <form method="POST" action="{{SITEURL}}/tags/{{ tag.name }}/rename">
        <div class="modal-header">
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          <h4 class="modal-title">Rename Tag</h4>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="new_name">New Name</label>
            <input type="text" name="new_name" id="new_name" class="form-control" value="{{ tag.name }}" required autofocus>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Rename</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Merge Tag Modal -->
<div class="modal fade" id="mergeTagModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <form method="POST" action="{{SITEURL}}/tags/{{ tag.name }}/merge">
        <div class="modal-header">
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          <h4 class="modal-title">Merge Tag</h4>
        </div>
        <div class="modal-body">
          <p>Merge all photos tagged with <strong>{{ tag.name }}</strong> into another tag:</p>
          <div class="form-group">
            <label for="target_tag">Target Tag Name</label>
            <input type="text" name="target_tag" id="target_tag" class="form-control" required>
            <p class="help-block">The tag to merge into (will be created if it doesn't exist)</p>
          </div>
          <div class="alert alert-warning">
            <strong>Warning:</strong> This will delete the "{{ tag.name }}" tag and move all {{ photo_count }} photos to the target tag. This action cannot be undone.
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-warning">Merge Tags</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endif %}

<br><br>
{% endblock %}
