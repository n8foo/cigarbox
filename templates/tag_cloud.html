{% extends "layout.html" %}
{% block body %}

<div class="container-fluid">
  <div class="row">
    <div class="col-md-12">
      <h1>Tags</h1>
      <hr>
    </div>
  </div>

  <!-- Statistics Banner -->
  {% set tag_list = tags | list %}
  {% set total_tags = tag_list | length %}

  <div class="row">
    <div class="col-md-12">
      <div class="alert alert-info">
        <span class="bi bi-tags-fill"></span>
        <strong>{{ total_tags }}</strong> tag{{ 's' if total_tags != 1 else '' }} organizing <strong>{{ total_photos }}</strong> photo{{ 's' if total_photos != 1 else '' }}
      </div>
    </div>
  </div>

  <!-- Search and Sort Controls -->
  <div class="row mb-3">
    <div class="col-md-6">
      <div class="input-group">
        <span class="input-group-text"><span class="bi bi-search"></span></span>
        <input type="text" id="tagSearch" class="form-control" placeholder="Search tags...">
      </div>
    </div>
    <div class="col-md-6 text-end">
      <div class="btn-group" role="group">
        <button type="button" class="btn btn-primary active" id="sortByCount" data-sort="count">
          <span class="bi bi-sort-numeric-down"></span> By Count
        </button>
        <button type="button" class="btn btn-outline-primary" id="sortByName" data-sort="name">
          <span class="bi bi-sort-alpha-down"></span> A-Z
        </button>
      </div>
    </div>
  </div>

  <!-- Tag Pills Flow -->
  <div id="tagGrid" style="display: flex; flex-wrap: wrap; gap: 0.75rem; align-items: center; padding: 2rem 0;">
    {% for tag in tag_list %}
    {% set scale = 0.8 + (tag.count ** 0.4 / 10) %}
    {% set scale = [scale, 2.5] | min %}
    <a href="{{SITEURL}}/tags/{{ tag.name }}"
       class="tag-pill text-decoration-none"
       data-tag-name="{{ tag.name | lower }}"
       data-count="{{ tag.count }}"
       style="--tag-scale: {{ scale }};"
       title="{{ tag.name }}: {{ tag.count }} photo{{ 's' if tag.count != 1 else '' }}">
      <span class="tag-name">{{ tag.name }}</span>
      <span class="tag-count">{{ tag.count }}</span>
    </a>
    {% else %}
    <div class="col-md-12">
      <p class="text-muted text-center">No tags yet!</p>
    </div>
    {% endfor %}
  </div>

  <!-- No Results Message -->
  <div class="row" id="noResults" style="display: none;">
    <div class="col-md-12">
      <p class="text-muted text-center">No tags match your search.</p>
    </div>
  </div>
</div>

<style>
/* Flowing pill layout */
.tag-pill {
  --scale-max: 2.5; /* Default for desktop */
  --scale: min(var(--tag-scale), var(--scale-max));

  display: inline-flex;
  align-items: center;
  gap: calc(0.5rem * var(--scale));
  padding: calc(0.4rem * var(--scale)) calc(1rem * var(--scale));
  border-radius: calc(2rem * var(--scale));
  background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
  color: white;
  font-size: calc(0.85rem * var(--scale));
  font-weight: 500;
  white-space: nowrap;
  transition: all 0.3s ease;
  cursor: pointer;
}

.tag-pill .tag-name {
  font-weight: 600;
}

.tag-pill .tag-count {
  opacity: 0.85;
  font-weight: 400;
  font-size: calc(0.75rem * var(--scale));
}

.tag-pill .tag-count::before {
  content: "Â·";
  margin-right: calc(0.4rem * var(--scale));
}

/* Responsive scale caps for smaller viewports */
@media (max-width: 768px) {
  .tag-pill {
    --scale-max: 1.8;
  }
}

@media (max-width: 480px) {
  .tag-pill {
    --scale-max: 1.4;
  }
}

/* Hover effects */
.tag-pill:hover {
  transform: translateY(-2px) scale(1.05);
  box-shadow: 0 0.5rem 1.5rem rgba(13, 110, 253, 0.4);
  background: linear-gradient(135deg, #0b5ed7 0%, #084298 100%);
}

[data-bs-theme="dark"] .tag-pill {
  background: linear-gradient(135deg, #0a58ca 0%, #084298 100%);
}

[data-bs-theme="dark"] .tag-pill:hover {
  box-shadow: 0 0.5rem 1.5rem rgba(13, 110, 253, 0.6);
  background: linear-gradient(135deg, #084298 0%, #052c65 100%);
}

/* Smooth show/hide for filtering */
.tag-pill.hidden {
  opacity: 0;
  transform: scale(0);
  pointer-events: none;
  position: absolute;
  left: -9999px;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const searchInput = document.getElementById('tagSearch');
  const tagPills = document.querySelectorAll('.tag-pill');
  const noResults = document.getElementById('noResults');
  const sortByCountBtn = document.getElementById('sortByCount');
  const sortByNameBtn = document.getElementById('sortByName');
  const tagGrid = document.getElementById('tagGrid');

  let currentSort = 'count'; // default sort

  // Search/Filter functionality
  searchInput.addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase().trim();
    let visibleCount = 0;

    tagPills.forEach(function(pill) {
      const tagName = pill.getAttribute('data-tag-name');

      if (tagName.includes(searchTerm)) {
        pill.classList.remove('hidden');
        visibleCount++;
      } else {
        pill.classList.add('hidden');
      }
    });

    // Show/hide no results message
    if (visibleCount === 0 && searchTerm !== '') {
      noResults.style.display = 'flex';
    } else {
      noResults.style.display = 'none';
    }
  });

  // Sort functionality
  function sortTags(sortBy) {
    const pillsArray = Array.from(tagPills);

    pillsArray.sort(function(a, b) {
      if (sortBy === 'count') {
        // Sort by count descending
        return parseInt(b.getAttribute('data-count')) - parseInt(a.getAttribute('data-count'));
      } else {
        // Sort alphabetically ascending
        const nameA = a.getAttribute('data-tag-name');
        const nameB = b.getAttribute('data-tag-name');
        return nameA.localeCompare(nameB);
      }
    });

    // Re-append pills in new order
    pillsArray.forEach(function(pill) {
      tagGrid.appendChild(pill);
    });
  }

  // Sort button handlers
  sortByCountBtn.addEventListener('click', function() {
    if (currentSort !== 'count') {
      currentSort = 'count';
      sortTags('count');

      // Update button states
      sortByCountBtn.classList.remove('btn-outline-primary');
      sortByCountBtn.classList.add('btn-primary', 'active');
      sortByNameBtn.classList.remove('btn-primary', 'active');
      sortByNameBtn.classList.add('btn-outline-primary');
    }
  });

  sortByNameBtn.addEventListener('click', function() {
    if (currentSort !== 'name') {
      currentSort = 'name';
      sortTags('name');

      // Update button states
      sortByNameBtn.classList.remove('btn-outline-primary');
      sortByNameBtn.classList.add('btn-primary', 'active');
      sortByCountBtn.classList.remove('btn-primary', 'active');
      sortByCountBtn.classList.add('btn-outline-primary');
    }
  });

  // Initial sort by count (default)
  sortTags('count');
});
</script>

<br><br>
{% endblock %}
