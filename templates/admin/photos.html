{% extends "admin/admin_base.html" %}
{% set active_page = 'photos' %}

{% block admin_content %}

<div class="row">
  <div class="col-md-12">
    <h1>Photo Management</h1>
    <hr>
  </div>
</div>

<!-- Search Form -->
<div class="row">
  <div class="col-md-12">
    <form method="GET" action="{{SITEURL}}/admin/photos" class="form-inline">
      <div class="form-group">
        <input type="text" name="search" class="form-control" placeholder="Search by ID or SHA1" value="{{ search }}">
      </div>
      <button type="submit" class="btn btn-primary">Search</button>
      {% if search %}
      <a href="{{SITEURL}}/admin/photos" class="btn btn-default">Clear</a>
      {% endif %}
    </form>
    <br>
  </div>
</div>

<!-- Photo List -->
<div class="row">
  <div class="col-md-12">
    <table class="table table-striped table-hover">
      <thead>
        <tr>
          <th>Thumbnail</th>
          <th>ID</th>
          <th>Date Taken</th>
          <th>Privacy</th>
          <th>Tags</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for photo in photos %}
        <tr>
          <td>
            <a href="{{SITEURL}}/photos/{{ photo.id }}">
              <img class="lazy"
                   data-src="http://s3.amazonaws.com/{{ config['S3_BUCKET_NAME'] }}/{{ photo.uri }}_t.jpg"
                   src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='50' height='50'%3E%3Crect fill='%23eee' width='50' height='50'/%3E%3C/svg%3E"
                   alt="Photo {{ photo.id }}"
                   style="max-width: 50px;">
            </a>
          </td>
          <td>{{ photo.id }}</td>
          <td>{{ photo.datetaken | format_datetime }}</td>
          <td>
            {% if photo.privacy == 0 or photo.privacy is none %}
            <span class="label label-success">Public</span>
            {% elif photo.privacy == 1 %}
            <span class="label label-info">Friends</span>
            {% elif photo.privacy == 2 %}
            <span class="label label-warning">Family</span>
            {% elif photo.privacy == 3 %}
            <span class="label label-danger">Private</span>
            {% endif %}
          </td>
          <td>
            {% for tag in photo.tag_list %}
            <span class="label label-default">{{ tag.name }}</span>
            {% endfor %}
          </td>
          <td>
            <a href="{{SITEURL}}/admin/photos/{{ photo.id }}/edit" class="btn btn-xs btn-primary">Edit</a>
            <a href="{{SITEURL}}/photos/{{ photo.id }}/delete" class="btn btn-xs btn-danger" onclick="return confirm('Are you sure you want to delete this photo?');">Delete</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Pagination -->
{% if pagination.total_pages > 1 %}
{% include '_pagination.html' %}
{% endif %}

<script>
// Lazy load images
document.addEventListener('DOMContentLoaded', function() {
  var lazyImages = document.querySelectorAll('img.lazy');

  if ('IntersectionObserver' in window) {
    var imageObserver = new IntersectionObserver(function(entries, observer) {
      entries.forEach(function(entry) {
        if (entry.isIntersecting) {
          var img = entry.target;
          img.src = img.dataset.src;
          img.classList.remove('lazy');
          imageObserver.unobserve(img);
        }
      });
    }, {
      rootMargin: '200px'
    });

    lazyImages.forEach(function(img) {
      imageObserver.observe(img);
    });
  } else {
    // Fallback for older browsers
    lazyImages.forEach(function(img) {
      img.src = img.dataset.src;
    });
  }
});
</script>

{% endblock admin_content %}
