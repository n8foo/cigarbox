{% extends "admin/admin_base.html" %}
{% set active_page = 'tools' %}

{% block admin_content %}

<div class="row">
  <div class="col-md-12">
    <h1>Database Migrations</h1>
    <hr>
    <p class="lead">Run database schema migrations and view execution history</p>
    <div class="alert alert-info">
      <span class="bi bi-info-circle"></span>
      <strong>Note:</strong> All migrations are idempotent and safe to run multiple times.
      They check the current schema and skip if already applied.
    </div>
  </div>
</div>

<!-- Available Migrations -->
<div class="row">
  <div class="col-md-12">
    <h2>Available Migrations</h2>
  </div>
</div>

{% for migration in migrations %}
<div class="row">
  <div class="col-md-12">
    <div class="panel panel-default">
      <div class="panel-heading">
        <h3 class="panel-title">
          <span class="bi bi-file-earmark"></span>
          {{ migration.filename }}
        </h3>
      </div>
      <div class="panel-body">
        {% if migration.description %}
        <p>{{ migration.description }}</p>
        {% else %}
        <p class="text-muted">No description available</p>
        {% endif %}

        <!-- Recent Runs -->
        {% if migration.recent_runs %}
        <h4>Recent Runs</h4>
        <ul class="list-unstyled">
          {% for run in migration.recent_runs %}
          <li>
            <span class="bi bi-clock"></span>
            <strong>{{ run.timestamp }}</strong>
            {% if run.success %}
            <span class="badge bg-success">Success</span>
            {% else %}
            <span class="badge bg-danger">Failed</span>
            {% endif %}
            <a href="{{SITEURL}}/admin/tools/migrations/log/{{ run.log_file }}" class="btn btn-xs btn-secondary">
              <span class="bi bi-eye"></span> View Log
            </a>
          </li>
          {% endfor %}
        </ul>
        {% else %}
        <p class="text-muted"><em>Never run</em></p>
        {% endif %}

        <!-- Run Button -->
        <form method="POST" action="{{SITEURL}}/admin/tools/migrations/run" style="display: inline;">
          <input type="hidden" name="migration" value="{{ migration.filename }}">
          <button type="submit" class="btn btn-primary" onclick="return confirm('Run migration: {{ migration.filename }}?');">
            <span class="bi bi-play-fill"></span> Run Migration
          </button>
        </form>

        {% if migration.recent_runs %}
        <a href="{{SITEURL}}/admin/tools/migrations/history/{{ migration.filename }}" class="btn btn-secondary">
          <span class="bi bi-list"></span> View All Logs
        </a>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endfor %}

{% if not migrations %}
<div class="row">
  <div class="col-md-12">
    <div class="alert alert-warning">
      <span class="bi bi-exclamation-triangle"></span>
      No migration scripts found in <code>scripts/</code> directory.
    </div>
  </div>
</div>
{% endif %}

<div class="row">
  <div class="col-md-12">
    <a href="{{SITEURL}}/admin/tools" class="btn btn-secondary">
      <span class="bi bi-arrow-left"></span> Back to Tools
    </a>
  </div>
</div>

{% endblock admin_content %}
