{% extends "layout.html" %}

{# Set Open Graph variables for social media preview #}
{% set og_image = photo.uri %}
{% set og_title = 'Photo #' + photo.id|string %}
{% set og_url = request.url %}
{% if photo.datetaken %}
{% set og_description = 'Photo taken on ' + (photo.datetaken | format_datetime('%Y-%m-%d')) %}
{% set og_image_alt = 'Photo from ' + (photo.datetaken | format_datetime('%Y-%m-%d')) %}
{% else %}
{% set og_description = 'A photo from CigarBox' %}
{% set og_image_alt = 'Photo #' + photo.id|string %}
{% endif %}

{% block body %}
  <div class="container">
    <!-- Share Link Success Alert -->
    {% if session.share_link %}
    <div class="row">
      <div class="col-md-12">
        <div class="alert alert-success alert-dismissible" role="alert">
          <button type="button" class="close" data-dismiss="alert">&times;</button>
          <h4><span class="glyphicon glyphicon-ok-circle"></span> Share Link Created!</h4>
          <p>Copy this link to share this photo:</p>
          <div class="input-group">
            <input type="text" class="form-control" value="{{ session.share_link }}" id="shareUrlInput" readonly>
            <span class="input-group-btn">
              <button class="btn btn-primary" type="button" onclick="copyShareLink()">
                <span class="glyphicon glyphicon-copy"></span> Copy
              </button>
            </span>
          </div>
          <p class="help-block" style="margin-top: 10px;">
            {% if session.share_expires and session.share_expires > 0 %}
            This link will expire in {{ session.share_expires }} days.
            {% else %}
            This link never expires.
            {% endif %}
          </p>
        </div>
      </div>
    </div>
    {% set _ = session.pop('share_link', None) %}
    {% set _ = session.pop('share_expires', None) %}
    {% endif %}

    <!-- Header with Navigation and Actions -->
    <div class="row">
      <div class="col-md-6">
        {% if context_name %}
        <ol class="breadcrumb">
          <li><a href="{{ context_url }}">{{ context_name }}</a></li>
          <li class="active">
            Photo #{{ photo.id }}
            {% if photo.datetaken %}
            <span style="margin-left: 15px;">
              <a href="{{SITEURL}}/date/{{ photo.datetaken | format_datetime('%Y-%m-%d') }}">
                <span class="glyphicon glyphicon-calendar"></span> {{ photo.datetaken | format_datetime }}
              </a>
            </span>
            {% endif %}
          </li>
        </ol>
        {% else %}
        <h3>
          Photo #{{ photo.id }}
          {% if photo.datetaken %}
          <small class="text-muted">
            <a href="{{SITEURL}}/date/{{ photo.datetaken | format_datetime('%Y-%m-%d') }}">
              <span class="glyphicon glyphicon-calendar"></span> {{ photo.datetaken | format_datetime }}
            </a>
          </small>
          {% endif %}
        </h3>
        {% endif %}
        {% if photo_photosets and photo_photosets.count() > 0 %}
          {% set other_photosets = [] %}
          {% for pp in photo_photosets %}
            {% if pp.photoset.id != context_photoset_id %}
              {% set _ = other_photosets.append(pp) %}
            {% endif %}
          {% endfor %}
          {% if other_photosets|length > 0 %}
        <p class="text-muted" style="font-size: 14px; margin-top: 3px; margin-bottom: 0;">
          <span class="glyphicon glyphicon-folder-open"></span>
          {% for pp in other_photosets %}
          <a href="{{SITEURL}}/photosets/{{ pp.photoset.id }}" class="label label-primary">{{ pp.photoset.title }}</a>
          {% endfor %}
        </p>
          {% endif %}
        {% endif %}
      </div>
      <div class="col-md-6 text-right">
        {% if tags %}
        <p class="text-muted">
          <span class="glyphicon glyphicon-tag"></span>
          {% for tag in tags %}
          <a href="{{SITEURL}}/tags/{{ tag.name }}" class="label label-default">{{ tag.name }}</a>
          {% endfor %}
        </p>
        {% endif %}
        {% if current_user.is_authenticated and can_edit %}
        <div class="btn-group btn-group-sm">
          <button type="button" class="btn btn-link" data-toggle="modal" data-target="#privacyModal" title="Privacy">
            <span class="glyphicon glyphicon-lock"></span>
            {% if photo.privacy == 0 or photo.privacy is none %}
            <span class="text-success">public</span>
            {% elif photo.privacy == 1 %}
            <span class="text-info">friends</span>
            {% elif photo.privacy == 2 %}
            <span class="text-warning">family</span>
            {% elif photo.privacy == 3 %}
            <span class="text-danger">private</span>
            {% endif %}
          </button>
          <button type="button" class="btn btn-link" data-toggle="modal" data-target="#tagsModal" title="Edit Tags">
            <span class="glyphicon glyphicon-tag"></span> edit
          </button>
          <a href="{{SITEURL}}/photos/{{ photo.id }}/original" class="btn btn-link" target="_blank" title="View Original">
            <span class="glyphicon glyphicon-picture"></span> original
          </a>
          <button type="button" class="btn btn-link" data-toggle="modal" data-target="#shareModal" title="Share">
            <span class="glyphicon glyphicon-share"></span> share
            <span class="badge" id="shareCountBadge" style="display: none; background-color: #d9534f;"></span>
          </button>
          <button type="button" class="btn btn-link text-danger" onclick="deletePhoto({{ photo.id }})" title="Delete">
            <span class="glyphicon glyphicon-trash"></span> delete
          </button>
        </div>
        {% endif %}
      </div>
    </div>
    <hr>

    <div class="row">
      <div class="col-md-12">
        <img class='img-responsive' src="http://s3.amazonaws.com/{{ config['S3_BUCKET_NAME'] }}/{{ photo.uri }}_b.jpg">
      </div>
    </div>

    <!-- Navigation Buttons -->
    {% if prev_photo or next_photo %}
    <div class="row" style="margin-top: 15px;">
      <div class="col-md-12 text-center">
        <div class="btn-group" role="group">
          {% if prev_photo %}
          <a href="{{SITEURL}}/photos/{{ prev_photo.id }}?context={{ context }}" class="btn btn-default" id="prevPhotoBtn">
            <span class="glyphicon glyphicon-chevron-left"></span> Previous
          </a>
          {% else %}
          <button class="btn btn-default" disabled>
            <span class="glyphicon glyphicon-chevron-left"></span> Previous
          </button>
          {% endif %}

          <a href="{{ context_url }}" class="btn btn-primary">
            <span class="glyphicon glyphicon-th"></span> Back to {{ context_name }}
          </a>

          {% if next_photo %}
          <a href="{{SITEURL}}/photos/{{ next_photo.id }}?context={{ context }}" class="btn btn-default" id="nextPhotoBtn">
            Next <span class="glyphicon glyphicon-chevron-right"></span>
          </a>
          {% else %}
          <button class="btn btn-default" disabled>
            Next <span class="glyphicon glyphicon-chevron-right"></span>
          </button>
          {% endif %}
        </div>
      </div>
    </div>
    {% endif %}

      <!-- Share Modal -->
      <div class="modal fade" id="shareModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <form method="POST" action="{{SITEURL}}/photos/{{ photo.id }}/share">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Create Share Link</h4>
              </div>
              <div class="modal-body">
                <p>Create a secure link to share this photo with others.</p>

                <div class="form-group">
                  <label for="comment">Comment / Note</label>
                  <textarea name="comment" id="comment" class="form-control" rows="2" placeholder="Optional note about this share (e.g., who it's for, why it was created)"></textarea>
                  <small class="text-muted">This note is for your reference only.</small>
                </div>

                <div class="form-group">
                  <label for="days">Expiration</label>
                  <select name="days" id="days" class="form-control">
                    <option value="1">1 day</option>
                    <option value="7">7 days</option>
                    <option value="30" selected>30 days</option>
                    <option value="90">90 days</option>
                    <option value="365">1 year</option>
                    <option value="0">Never expires</option>
                  </select>
                </div>

                <div class="form-group">
                  <label for="max_views">Max Views</label>
                  <input type="number" name="max_views" id="max_views" class="form-control" min="1" placeholder="Unlimited">
                  <small class="text-muted">Leave blank for unlimited views.</small>
                </div>

                <div class="checkbox">
                  <label>
                    <input type="checkbox" name="allow_download"> Allow downloading original photo
                  </label>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-primary">Create Link</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      {% if can_edit %}
      <!-- Privacy Modal -->
      <div class="modal fade" id="privacyModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-sm" role="document">
          <div class="modal-content">
            <form method="POST" action="{{SITEURL}}/photos/{{ photo.id }}/update">
              <input type="hidden" name="action" value="privacy">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Change Privacy</h4>
              </div>
              <div class="modal-body">
                <div class="form-group">
                  <label for="privacy">Privacy Level</label>
                  <select name="privacy" id="privacy" class="form-control">
                    <option value="0" {% if photo.privacy == 0 or photo.privacy is none %}selected{% endif %}>Public</option>
                    <option value="1" {% if photo.privacy == 1 %}selected{% endif %}>Friends</option>
                    <option value="2" {% if photo.privacy == 2 %}selected{% endif %}>Family</option>
                    <option value="3" {% if photo.privacy == 3 %}selected{% endif %}>Private</option>
                  </select>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-primary">Save</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Tags Modal -->
      <div class="modal fade" id="tagsModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <form method="POST" action="{{SITEURL}}/photos/{{ photo.id }}/update">
              <input type="hidden" name="action" value="tags">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Edit Tags</h4>
              </div>
              <div class="modal-body">
                <div class="form-group">
                  <label for="tags">Tags (comma-separated)</label>
                  <input type="text" name="tags" id="tags" class="form-control"
                         value="{% for tag in tags %}{{ tag.name }}{% if not loop.last %}, {% endif %}{% endfor %}">
                  <p class="help-block">Enter tags separated by commas (e.g., vacation, beach, summer)</p>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-primary">Save</button>
              </div>
            </form>
          </div>
        </div>
      </div>
      {% endif %}

      <!-- Keyboard Shortcuts Help Modal -->
      <div class="modal fade" id="keyboardHelpModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <button type="button" class="close" data-dismiss="modal">&times;</button>
              <h4 class="modal-title"><span class="glyphicon glyphicon-keyboard"></span> Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <h5>Navigation</h5>
              <dl class="dl-horizontal">
                <dt><kbd>←</kbd></dt><dd>Previous photo</dd>
                <dt><kbd>→</kbd></dt><dd>Next photo</dd>
                <dt><kbd>↑</kbd></dt><dd>Back to {{ context_name|default('context') }}</dd>
              </dl>

              {% if current_user.is_authenticated and can_edit %}
              <h5>Photo Actions</h5>
              <dl class="dl-horizontal">
                <dt><kbd>t</kbd></dt><dd>Edit tags</dd>
                <dt><kbd>p</kbd></dt><dd>Change privacy</dd>
                <dt><kbd>s</kbd></dt><dd>Share photo</dd>
                <dt><kbd>o</kbd></dt><dd>View original</dd>
                <dt><kbd>Del</kbd></dt><dd>Delete photo</dd>
              </dl>
              {% endif %}

              <h5>General</h5>
              <dl class="dl-horizontal">
                <dt><kbd>?</kbd></dt><dd>Show this help</dd>
                <dt><kbd>Esc</kbd></dt><dd>Close modals</dd>
              </dl>

              <p class="text-muted"><small><em>Tip: Hold Alt/Cmd/Ctrl with arrow keys for browser navigation</em></small></p>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
  <br><br>

  <script>
  function copyShareLink() {
    var input = document.getElementById('shareUrlInput');
    input.select();
    input.setSelectionRange(0, 99999); // For mobile

    try {
      document.execCommand('copy');
      var btn = event.target.closest('button');
      var originalText = btn.innerHTML;
      btn.innerHTML = '<span class="glyphicon glyphicon-ok"></span> Copied!';
      setTimeout(function() {
        btn.innerHTML = originalText;
      }, 2000);
    } catch (err) {
      alert('Failed to copy. Please copy manually: ' + input.value);
    }
  }

  function deletePhoto(photoId) {
    if (confirm('Are you sure you want to delete this photo? This cannot be undone.')) {
      window.location.href = '{{SITEURL}}/photos/' + photoId + '/delete';
    }
  }

  // Load share count on page load
  function loadShareCount() {
    fetch('{{SITEURL}}/photos/{{ photo.id }}/shares')
      .then(response => response.json())
      .then(data => {
        if (data.shares && data.shares.length > 0) {
          var badge = document.getElementById('shareCountBadge');
          badge.textContent = data.shares.length;
          badge.style.display = 'inline';

          // Make badge clickable to go to admin shares page
          badge.style.cursor = 'pointer';
          badge.onclick = function(e) {
            e.stopPropagation(); // Don't trigger the modal
            window.location.href = '{{SITEURL}}/admin/shares?search={{ photo.id }}';
          };
        }
      })
      .catch(error => {
        console.error('Error loading share count:', error);
      });
  }

  // Load count on page load
  {% if current_user.is_authenticated %}
  loadShareCount();
  {% endif %}

  // Keyboard shortcuts for photo page
  document.addEventListener('keydown', function(e) {
    // Ignore if user is typing in an input field
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
      return;
    }

    // Ignore if modifier keys are pressed (Alt/Cmd/Ctrl for browser navigation)
    if (e.altKey || e.metaKey || e.ctrlKey) {
      return;
    }

    // Arrow key navigation (left/right for photos, up for back)
    if (e.key === 'ArrowLeft') {
      var prevBtn = document.getElementById('prevPhotoBtn');
      if (prevBtn) {
        e.preventDefault();
        window.location.href = prevBtn.href;
      }
    } else if (e.key === 'ArrowRight') {
      var nextBtn = document.getElementById('nextPhotoBtn');
      if (nextBtn) {
        e.preventDefault();
        window.location.href = nextBtn.href;
      }
    } else if (e.key === 'ArrowUp') {
      // Back to context (works for all users)
      var backBtn = document.querySelector('a.btn-primary[href="{{ context_url }}"]');
      if (backBtn) {
        e.preventDefault();
        window.location.href = backBtn.href;
      }
    }
    {% if current_user.is_authenticated and can_edit %}
    // Edit shortcuts (logged in users only)
    else if (e.key === 't' || e.key === 'T') {
      e.preventDefault();
      $('#tagsModal').modal('show');
    } else if (e.key === 'p' || e.key === 'P') {
      e.preventDefault();
      $('#privacyModal').modal('show');
    } else if (e.key === 's' || e.key === 'S') {
      e.preventDefault();
      $('#shareModal').modal('show');
    } else if (e.key === 'o' || e.key === 'O') {
      e.preventDefault();
      window.open('{{SITEURL}}/photos/{{ photo.id }}/original', '_blank');
    } else if (e.key === 'Delete' || e.key === 'Backspace') {
      e.preventDefault();
      deletePhoto({{ photo.id }});
    }
    {% endif %}
    else if (e.key === '?') {
      e.preventDefault();
      $('#keyboardHelpModal').modal('show');
    } else if (e.key === 'Escape') {
      // Close any open modals
      $('.modal').modal('hide');
    }
  });

  // Auto-focus inputs when modals open
  {% if current_user.is_authenticated and can_edit %}
  $('#tagsModal').on('shown.bs.modal', function() {
    $('#tags').focus();
  });
  $('#privacyModal').on('shown.bs.modal', function() {
    $('#privacy').focus();
  });
  {% endif %}
  </script>
{% endblock %}