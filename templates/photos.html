{% extends "layout.html" %}
{% set twitter_card_image = photo.uri %}
{% block body %}
  <div class="container">
    <!-- Share Link Success Alert -->
    {% if session.share_link %}
    <div class="row">
      <div class="col-md-12">
        <div class="alert alert-success alert-dismissible" role="alert">
          <button type="button" class="close" data-dismiss="alert">&times;</button>
          <h4><span class="glyphicon glyphicon-ok-circle"></span> Share Link Created!</h4>
          <p>Copy this link to share this photo:</p>
          <div class="input-group">
            <input type="text" class="form-control" value="{{ session.share_link }}" id="shareUrlInput" readonly>
            <span class="input-group-btn">
              <button class="btn btn-primary" type="button" onclick="copyShareLink()">
                <span class="glyphicon glyphicon-copy"></span> Copy
              </button>
            </span>
          </div>
          <p class="help-block" style="margin-top: 10px;">
            {% if session.share_expires and session.share_expires > 0 %}
            This link will expire in {{ session.share_expires }} days.
            {% else %}
            This link never expires.
            {% endif %}
          </p>
        </div>
      </div>
    </div>
    {% set _ = session.pop('share_link', None) %}
    {% set _ = session.pop('share_expires', None) %}
    {% endif %}

    <div class="row">
      <div class="col-md-12">
        <img class='img-responsive' src="http://s3.amazonaws.com/{{ config['S3_BUCKET_NAME'] }}/{{ photo.uri }}_b.jpg">
      </div>
      <!-- Photo Details -->
      <div class="col-md-12">
        <hr>
        <dl class="dl-horizontal">
          <dt>Privacy:</dt>
          <dd>
            {% if photo.privacy == 0 or photo.privacy is none %}
            <span class="label label-success">Public</span>
            {% elif photo.privacy == 1 %}
            <span class="label label-info">Friends</span>
            {% elif photo.privacy == 2 %}
            <span class="label label-warning">Family</span>
            {% elif photo.privacy == 3 %}
            <span class="label label-danger">Private</span>
            {% endif %}

            {% if current_user.is_authenticated and can_edit %}
            <button type="button" class="btn btn-xs btn-default" data-toggle="modal" data-target="#privacyModal">
              <span class="glyphicon glyphicon-pencil"></span> Change
            </button>
            {% endif %}
          </dd>

          <dt>Tags:</dt>
          <dd>
            {% for tag in tags %}
            <a href="{{SITEURL}}/tags/{{ tag.name }}" class="label label-default">{{  tag.name  }}</a>
            {% else %}
            <span class="text-muted">No tags</span>
            {% endfor %}

            {% if current_user.is_authenticated and can_edit %}
            <button type="button" class="btn btn-xs btn-default" data-toggle="modal" data-target="#tagsModal">
              <span class="glyphicon glyphicon-tag"></span> Edit Tags
            </button>
            {% endif %}
          </dd>

          <dt>Date Taken:</dt>
          <dd>
            {% if photo.datetaken %}
            <a href="{{SITEURL}}/date/{{ photo.datetaken.strftime('%Y-%m-%d') }}">{{ photo.datetaken.strftime('%Y-%m-%d %H:%M') }}</a>
            {% else %}
            <span class="text-muted">Unknown</span>
            {% endif %}
          </dd>

          {% if photo_photosets and photo_photosets.count() > 0 %}
          <dt>In Photosets:</dt>
          <dd>
            {% for pp in photo_photosets %}
            <a href="{{SITEURL}}/photosets/{{ pp.photoset.id }}" class="label label-primary">{{ pp.photoset.title }}</a>
            {% endfor %}
          </dd>
          {% endif %}
        </dl>
      </div>

      <!-- Action Buttons -->
      {% if current_user.is_authenticated %}
      <div class="col-md-12" align="left">
        <br>
        <a href="{{SITEURL}}/photos/{{ photo.id }}/original" class="btn btn-sm btn-primary" target="_blank">
          <span class="glyphicon glyphicon-picture"></span> View Original
        </a>
        <button type="button" class="btn btn-sm btn-info" data-toggle="modal" data-target="#shareModal">
          <span class="glyphicon glyphicon-share"></span> Share
        </button>
      </div>

      <!-- Share Modal -->
      <div class="modal fade" id="shareModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <form method="POST" action="{{SITEURL}}/photos/{{ photo.id }}/share">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Create Share Link</h4>
              </div>
              <div class="modal-body">
                <p>Create a secure link to share this photo with others.</p>
                <div class="form-group">
                  <label for="days">Expiration</label>
                  <select name="days" id="days" class="form-control">
                    <option value="1">1 day</option>
                    <option value="7">7 days</option>
                    <option value="30" selected>30 days</option>
                    <option value="90">90 days</option>
                    <option value="365">1 year</option>
                    <option value="0">Never expires</option>
                  </select>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-primary">Create Link</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      {% if can_edit %}
      <!-- Privacy Modal -->
      <div class="modal fade" id="privacyModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-sm" role="document">
          <div class="modal-content">
            <form method="POST" action="{{SITEURL}}/photos/{{ photo.id }}/update">
              <input type="hidden" name="action" value="privacy">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Change Privacy</h4>
              </div>
              <div class="modal-body">
                <div class="form-group">
                  <label for="privacy">Privacy Level</label>
                  <select name="privacy" id="privacy" class="form-control">
                    <option value="0" {% if photo.privacy == 0 or photo.privacy is none %}selected{% endif %}>Public</option>
                    <option value="1" {% if photo.privacy == 1 %}selected{% endif %}>Friends</option>
                    <option value="2" {% if photo.privacy == 2 %}selected{% endif %}>Family</option>
                    <option value="3" {% if photo.privacy == 3 %}selected{% endif %}>Private</option>
                  </select>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-primary">Save</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Tags Modal -->
      <div class="modal fade" id="tagsModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <form method="POST" action="{{SITEURL}}/photos/{{ photo.id }}/update">
              <input type="hidden" name="action" value="tags">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Edit Tags</h4>
              </div>
              <div class="modal-body">
                <div class="form-group">
                  <label for="tags">Tags (comma-separated)</label>
                  <input type="text" name="tags" id="tags" class="form-control"
                         value="{% for tag in tags %}{{ tag.name }}{% if not loop.last %}, {% endif %}{% endfor %}">
                  <p class="help-block">Enter tags separated by commas (e.g., vacation, beach, summer)</p>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-primary">Save</button>
              </div>
            </form>
          </div>
        </div>
      </div>
      {% endif %}

      {% endif %}

    </div>
  </div>
  <br><br>

  <script>
  function copyShareLink() {
    var input = document.getElementById('shareUrlInput');
    input.select();
    input.setSelectionRange(0, 99999); // For mobile

    try {
      document.execCommand('copy');
      var btn = event.target.closest('button');
      var originalText = btn.innerHTML;
      btn.innerHTML = '<span class="glyphicon glyphicon-ok"></span> Copied!';
      setTimeout(function() {
        btn.innerHTML = originalText;
      }, 2000);
    } catch (err) {
      alert('Failed to copy. Please copy manually: ' + input.value);
    }
  }
  </script>
{% endblock %}