{% extends "layout.html" %}

{# Set Open Graph variables for social media preview #}
{% set og_image = photo.uri %}
{% set og_title = 'Photo #' + photo.id|string %}
{% set og_url = request.url %}
{% if photo.datetaken %}
{% set og_description = 'Photo taken on ' + (photo.datetaken | format_datetime('%Y-%m-%d')) %}
{% set og_image_alt = 'Photo from ' + (photo.datetaken | format_datetime('%Y-%m-%d')) %}
{% else %}
{% set og_description = 'A photo from CigarBox' %}
{% set og_image_alt = 'Photo #' + photo.id|string %}
{% endif %}

{% block body %}
  <div class="container">
    <!-- Share Link Success Alert -->
    {% if session.share_link %}
    <div class="row">
      <div class="col-md-12">
        <div class="alert alert-success alert-dismissible" role="alert">
          <button type="button" class="close" data-dismiss="alert">&times;</button>
          <h4><span class="glyphicon glyphicon-ok-circle"></span> Share Link Created!</h4>
          <p>Copy this link to share this photo:</p>
          <div class="input-group">
            <input type="text" class="form-control" value="{{ session.share_link }}" id="shareUrlInput" readonly>
            <span class="input-group-btn">
              <button class="btn btn-primary" type="button" onclick="copyShareLink()">
                <span class="glyphicon glyphicon-copy"></span> Copy
              </button>
            </span>
          </div>
          <p class="help-block" style="margin-top: 10px;">
            {% if session.share_expires and session.share_expires > 0 %}
            This link will expire in {{ session.share_expires }} days.
            {% else %}
            This link never expires.
            {% endif %}
          </p>
        </div>
      </div>
    </div>
    {% set _ = session.pop('share_link', None) %}
    {% set _ = session.pop('share_expires', None) %}
    {% endif %}

    <!-- Navigation Breadcrumb -->
    {% if context_name %}
    <div class="row">
      <div class="col-md-12">
        <ol class="breadcrumb">
          <li><a href="{{ context_url }}">{{ context_name }}</a></li>
          <li class="active">Photo</li>
        </ol>
      </div>
    </div>
    {% endif %}

    <div class="row">
      <div class="col-md-12">
        <img class='img-responsive' src="http://s3.amazonaws.com/{{ config['S3_BUCKET_NAME'] }}/{{ photo.uri }}_b.jpg">
      </div>
    </div>

    <!-- Navigation Buttons -->
    {% if prev_photo or next_photo %}
    <div class="row" style="margin-top: 15px;">
      <div class="col-md-12 text-center">
        <div class="btn-group" role="group">
          {% if prev_photo %}
          <a href="{{SITEURL}}/photos/{{ prev_photo.id }}?context={{ context }}" class="btn btn-default" id="prevPhotoBtn">
            <span class="glyphicon glyphicon-chevron-left"></span> Previous
          </a>
          {% else %}
          <button class="btn btn-default" disabled>
            <span class="glyphicon glyphicon-chevron-left"></span> Previous
          </button>
          {% endif %}

          <a href="{{ context_url }}" class="btn btn-primary">
            <span class="glyphicon glyphicon-th"></span> Back to {{ context_name }}
          </a>

          {% if next_photo %}
          <a href="{{SITEURL}}/photos/{{ next_photo.id }}?context={{ context }}" class="btn btn-default" id="nextPhotoBtn">
            Next <span class="glyphicon glyphicon-chevron-right"></span>
          </a>
          {% else %}
          <button class="btn btn-default" disabled>
            Next <span class="glyphicon glyphicon-chevron-right"></span>
          </button>
          {% endif %}
        </div>
      </div>
    </div>
    {% endif %}

    <div class="row">
      <!-- Photo Details -->
      <div class="col-md-12">
        <hr>
        <dl class="dl-horizontal">
          <dt>Privacy:</dt>
          <dd>
            {% if photo.privacy == 0 or photo.privacy is none %}
            <span class="label label-success">Public</span>
            {% elif photo.privacy == 1 %}
            <span class="label label-info">Friends</span>
            {% elif photo.privacy == 2 %}
            <span class="label label-warning">Family</span>
            {% elif photo.privacy == 3 %}
            <span class="label label-danger">Private</span>
            {% endif %}

            {% if current_user.is_authenticated and can_edit %}
            <button type="button" class="btn btn-xs btn-default" data-toggle="modal" data-target="#privacyModal">
              <span class="glyphicon glyphicon-pencil"></span> Change
            </button>
            {% endif %}
          </dd>

          <dt>Tags:</dt>
          <dd>
            {% for tag in tags %}
            <a href="{{SITEURL}}/tags/{{ tag.name }}" class="label label-default">{{  tag.name  }}</a>
            {% else %}
            <span class="text-muted">No tags</span>
            {% endfor %}

            {% if current_user.is_authenticated and can_edit %}
            <button type="button" class="btn btn-xs btn-default" data-toggle="modal" data-target="#tagsModal">
              <span class="glyphicon glyphicon-tag"></span> Edit Tags
            </button>
            {% endif %}
          </dd>

          <dt>Date Taken:</dt>
          <dd>
            {% if photo.datetaken %}
            <a href="{{SITEURL}}/date/{{ photo.datetaken | format_datetime('%Y-%m-%d') }}">{{ photo.datetaken | format_datetime }}</a>
            {% else %}
            <span class="text-muted">Unknown</span>
            {% endif %}
          </dd>

          {% if photo_photosets and photo_photosets.count() > 0 %}
          <dt>In Photosets:</dt>
          <dd>
            {% for pp in photo_photosets %}
            <a href="{{SITEURL}}/photosets/{{ pp.photoset.id }}" class="label label-primary">{{ pp.photoset.title }}</a>
            {% endfor %}
          </dd>
          {% endif %}
        </dl>
      </div>

      <!-- Action Buttons -->
      {% if current_user.is_authenticated %}
      <div class="col-md-12" align="left">
        <br>
        <a href="{{SITEURL}}/photos/{{ photo.id }}/original" class="btn btn-sm btn-primary" target="_blank">
          <span class="glyphicon glyphicon-picture"></span> View Original
        </a>
        <button type="button" class="btn btn-sm btn-info" data-toggle="modal" data-target="#shareModal">
          <span class="glyphicon glyphicon-share"></span> Share
        </button>
        {% if can_edit %}
        <button type="button" class="btn btn-sm btn-danger" onclick="deletePhoto({{ photo.id }})">
          <span class="glyphicon glyphicon-trash"></span> Delete
        </button>
        {% endif %}
      </div>

      <!-- Share Management Section -->
      <div class="col-md-12" style="margin-top: 20px;">
        <div class="panel panel-default">
          <div class="panel-heading" style="cursor: pointer;" onclick="toggleShares()">
            <h4 class="panel-title">
              <span class="glyphicon glyphicon-link"></span> Active Shares
              <span class="glyphicon glyphicon-chevron-down pull-right" id="sharesChevron"></span>
            </h4>
          </div>
          <div class="panel-body" id="sharesPanel" style="display: none;">
            <div id="sharesList">
              <p class="text-muted"><em>Loading shares...</em></p>
            </div>
          </div>
        </div>
      </div>
      {% endif %}

      <!-- Share Modal -->
      <div class="modal fade" id="shareModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <form method="POST" action="{{SITEURL}}/photos/{{ photo.id }}/share">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Create Share Link</h4>
              </div>
              <div class="modal-body">
                <p>Create a secure link to share this photo with others.</p>

                <div class="form-group">
                  <label for="comment">Comment / Note</label>
                  <textarea name="comment" id="comment" class="form-control" rows="2" placeholder="Optional note about this share (e.g., who it's for, why it was created)"></textarea>
                  <small class="text-muted">This note is for your reference only.</small>
                </div>

                <div class="form-group">
                  <label for="days">Expiration</label>
                  <select name="days" id="days" class="form-control">
                    <option value="1">1 day</option>
                    <option value="7">7 days</option>
                    <option value="30" selected>30 days</option>
                    <option value="90">90 days</option>
                    <option value="365">1 year</option>
                    <option value="0">Never expires</option>
                  </select>
                </div>

                <div class="form-group">
                  <label for="max_views">Max Views</label>
                  <input type="number" name="max_views" id="max_views" class="form-control" min="1" placeholder="Unlimited">
                  <small class="text-muted">Leave blank for unlimited views.</small>
                </div>

                <div class="checkbox">
                  <label>
                    <input type="checkbox" name="allow_download"> Allow downloading original photo
                  </label>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-primary">Create Link</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      {% if can_edit %}
      <!-- Privacy Modal -->
      <div class="modal fade" id="privacyModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-sm" role="document">
          <div class="modal-content">
            <form method="POST" action="{{SITEURL}}/photos/{{ photo.id }}/update">
              <input type="hidden" name="action" value="privacy">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Change Privacy</h4>
              </div>
              <div class="modal-body">
                <div class="form-group">
                  <label for="privacy">Privacy Level</label>
                  <select name="privacy" id="privacy" class="form-control">
                    <option value="0" {% if photo.privacy == 0 or photo.privacy is none %}selected{% endif %}>Public</option>
                    <option value="1" {% if photo.privacy == 1 %}selected{% endif %}>Friends</option>
                    <option value="2" {% if photo.privacy == 2 %}selected{% endif %}>Family</option>
                    <option value="3" {% if photo.privacy == 3 %}selected{% endif %}>Private</option>
                  </select>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-primary">Save</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Tags Modal -->
      <div class="modal fade" id="tagsModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <form method="POST" action="{{SITEURL}}/photos/{{ photo.id }}/update">
              <input type="hidden" name="action" value="tags">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Edit Tags</h4>
              </div>
              <div class="modal-body">
                <div class="form-group">
                  <label for="tags">Tags (comma-separated)</label>
                  <input type="text" name="tags" id="tags" class="form-control"
                         value="{% for tag in tags %}{{ tag.name }}{% if not loop.last %}, {% endif %}{% endfor %}">
                  <p class="help-block">Enter tags separated by commas (e.g., vacation, beach, summer)</p>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-primary">Save</button>
              </div>
            </form>
          </div>
        </div>
      </div>
      {% endif %}

    </div>
  </div>
  <br><br>

  <script>
  function copyShareLink() {
    var input = document.getElementById('shareUrlInput');
    input.select();
    input.setSelectionRange(0, 99999); // For mobile

    try {
      document.execCommand('copy');
      var btn = event.target.closest('button');
      var originalText = btn.innerHTML;
      btn.innerHTML = '<span class="glyphicon glyphicon-ok"></span> Copied!';
      setTimeout(function() {
        btn.innerHTML = originalText;
      }, 2000);
    } catch (err) {
      alert('Failed to copy. Please copy manually: ' + input.value);
    }
  }

  function deletePhoto(photoId) {
    if (confirm('Are you sure you want to delete this photo? This cannot be undone.')) {
      window.location.href = '{{SITEURL}}/photos/' + photoId + '/delete';
    }
  }

  function toggleShares() {
    var panel = document.getElementById('sharesPanel');
    var chevron = document.getElementById('sharesChevron');

    if (panel.style.display === 'none') {
      panel.style.display = 'block';
      chevron.className = 'glyphicon glyphicon-chevron-up pull-right';
      loadShares();
    } else {
      panel.style.display = 'none';
      chevron.className = 'glyphicon glyphicon-chevron-down pull-right';
    }
  }

  function loadShares() {
    fetch('{{SITEURL}}/photos/{{ photo.id }}/shares')
      .then(response => response.json())
      .then(data => {
        var html = '';
        if (data.shares && data.shares.length > 0) {
          html += '<table class="table table-condensed table-striped">';
          html += '<thead><tr><th>Comment</th><th>Views</th><th>Created</th><th>Expires</th><th>Download</th><th>Actions</th></tr></thead>';
          html += '<tbody>';
          data.shares.forEach(function(share) {
            html += '<tr>';
            html += '<td>' + (share.comment || '<em class="text-muted">No comment</em>') + '</td>';
            html += '<td>' + share.views + (share.max_views ? '/' + share.max_views : '/âˆž') + '</td>';
            html += '<td>' + share.created_at + '</td>';
            html += '<td>' + (share.expires_at || '<em class="text-muted">Never</em>') + '</td>';
            html += '<td>' + (share.allow_download ? '<span class="glyphicon glyphicon-ok text-success"></span>' : '<span class="glyphicon glyphicon-remove text-muted"></span>') + '</td>';
            html += '<td>';
            html += '<button class="btn btn-xs btn-danger" onclick="revokeShare(' + share.id + ')"><span class="glyphicon glyphicon-ban-circle"></span> Revoke</button> ';
            html += '<button class="btn btn-xs btn-default" onclick="copyShareUrl(\'' + share.url + '\')"><span class="glyphicon glyphicon-copy"></span></button>';
            html += '</td>';
            html += '</tr>';
          });
          html += '</tbody></table>';
        } else {
          html = '<p class="text-muted"><em>No active shares for this photo.</em></p>';
        }
        document.getElementById('sharesList').innerHTML = html;
      })
      .catch(error => {
        document.getElementById('sharesList').innerHTML = '<p class="text-danger">Error loading shares.</p>';
        console.error('Error:', error);
      });
  }

  function revokeShare(shareId) {
    if (confirm('Revoke this share link? It will no longer work.')) {
      fetch('{{SITEURL}}/shares/' + shareId + '/revoke', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            loadShares(); // Reload the list
          } else {
            alert('Error: ' + (data.error || 'Failed to revoke share'));
          }
        })
        .catch(error => {
          alert('Error revoking share');
          console.error('Error:', error);
        });
    }
  }

  function copyShareUrl(url) {
    navigator.clipboard.writeText(url).then(function() {
      alert('Share URL copied to clipboard!');
    }).catch(function() {
      prompt('Copy this URL:', url);
    });
  }

  // Keyboard navigation for prev/next photos
  document.addEventListener('keydown', function(e) {
    // Ignore if user is typing in an input field
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
      return;
    }

    if (e.key === 'ArrowLeft') {
      var prevBtn = document.getElementById('prevPhotoBtn');
      if (prevBtn) {
        e.preventDefault();
        window.location.href = prevBtn.href;
      }
    } else if (e.key === 'ArrowRight') {
      var nextBtn = document.getElementById('nextPhotoBtn');
      if (nextBtn) {
        e.preventDefault();
        window.location.href = nextBtn.href;
      }
    }
  });
  </script>
{% endblock %}