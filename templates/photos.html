{% extends "layout.html" %}

{# Set Open Graph variables for social media preview #}
{% set og_image = photo.uri %}
{% set og_title = 'Photo #' + photo.id|string %}
{% set og_url = request.url %}
{% if photo.datetaken %}
{% set og_description = 'Photo taken on ' + (photo.datetaken | format_datetime('%Y-%m-%d')) %}
{% set og_image_alt = 'Photo from ' + (photo.datetaken | format_datetime('%Y-%m-%d')) %}
{% else %}
{% set og_description = 'A photo from CigarBox' %}
{% set og_image_alt = 'Photo #' + photo.id|string %}
{% endif %}

{% block body %}
  <div class="container">
    {% if not has_pow and config['POW_SPLIT_BRAIN_PHOTOS'] %}
    <!-- Split-brain mode: POW challenge only (no preview to prevent scraping) -->
    <div class="row" style="margin-top: 30px;">
      <div class="col-md-8 offset-md-2">
        <div style="padding: 30px; background-color: var(--bs-secondary-bg); border-radius: 8px;">
          <h4 class="text-center" style="margin-bottom: 20px;">üîí Verifying Browser</h4>
          <p class="text-center text-muted">This one-time check helps prevent automated scraping</p>

          <div id="pow-solving-status" style="text-align: center; margin-top: 20px;">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Solving...</span>
            </div>
            <p class="text-muted" style="margin-top: 10px;" id="pow-status-text">Starting verification...</p>
            <p id="pow-hash-attempts" class="text-muted" style="font-size: 12px;"></p>
          </div>
        </div>
      </div>
    </div>

    <!-- POW Challenge Solver -->
    <script src="{{SITEURL}}/static/js/pow.js"></script>
    <script>
      window.addEventListener('load', function() {
        CigarboxPOW.solve({
          returnUrl: window.location.pathname + window.location.search
        });
      });
    </script>

    {% else %}
    <!-- Full photo display (has POW token or split-brain disabled) -->
    {% if session.share_link %}
    <!-- Share Link Success Alert -->
    <div class="row">
      <div class="col-md-12">
        <div class="alert alert-success alert-dismissible" role="alert">
          <button type="button" class="close" data-bs-dismiss="alert">&times;</button>
          <h4><i class="bi bi-check-circle"></i> Share Link Created!</h4>
          <p>Copy this link to share this photo:</p>
          <div class="input-group">
            <input type="text" class="form-control" value="{{ session.share_link }}" id="shareUrlInput" readonly>
            <span class="input-group-btn">
              <button class="btn btn-primary" type="button" onclick="Cigarbox.copyShareLink()">
                <i class="bi bi-clipboard"></i> Copy
              </button>
            </span>
          </div>
          <p class="help-block" style="margin-top: 10px;">
            {% if session.share_expires and session.share_expires > 0 %}
            This link will expire in {{ session.share_expires }} days.
            {% else %}
            This link never expires.
            {% endif %}
          </p>
        </div>
      </div>
    </div>
    {% set _ = session.pop('share_link', None) %}
    {% set _ = session.pop('share_expires', None) %}
    {% endif %}

    <!-- Header with Navigation and Actions -->
    <div class="row" style="margin-bottom: 15px;">
      <div class="col-md-6">
        {% if context_name %}
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb" style="background-color: var(--bs-secondary-bg); padding: 12px 15px; border-radius: 4px;">
            <li class="breadcrumb-item"><a href="{{ context_url }}">{{ context_name }}</a></li>
            <li class="breadcrumb-item active" aria-current="page">Photo #{{ photo.id }}</li>
            {% if photo.datetaken %}
            <li class="breadcrumb-item">
              <a href="{{SITEURL}}/date/{{ photo.datetaken | format_datetime('%Y-%m-%d') }}">
                {{ photo.datetaken | format_datetime }}
              </a>
            </li>
            {% endif %}
          </ol>
        </nav>
        {% else %}
        <h3 style="margin-bottom: 10px;">
          Photo #{{ photo.id }}
        </h3>
        {% if photo.datetaken %}
        <p class="text-muted" style="font-size: 14px;">
          <a href="{{SITEURL}}/date/{{ photo.datetaken | format_datetime('%Y-%m-%d') }}" class="text-decoration-none">
            <i class="bi bi-calendar"></i> {{ photo.datetaken | format_datetime }}
          </a>
        </p>
        {% endif %}
        {% endif %}
        {% if photo_photosets and photo_photosets.count() > 0 %}
          {% set other_photosets = [] %}
          {% for pp in photo_photosets %}
            {% if pp.photoset.id != context_photoset_id %}
              {% set _ = other_photosets.append(pp) %}
            {% endif %}
          {% endfor %}
          {% if other_photosets|length > 0 %}
        <p class="text-muted" style="font-size: 14px; margin-top: 8px; margin-left: 15px;">
          <i class="bi bi-folder2-open"></i> <strong>In photosets:</strong>
          {% for pp in other_photosets %}
          <a href="{{SITEURL}}/photosets/{{ pp.photoset.id }}" class="badge bg-primary text-decoration-none" style="margin-left: 5px; margin-bottom: 3px;">{{ pp.photoset.title }}</a>
          {% endfor %}
        </p>
          {% endif %}
        {% endif %}
      </div>
      <div class="col-md-6">
        {% if tags %}
        <div style="padding: 12px 15px; background-color: var(--bs-secondary-bg); border-radius: 4px; margin-bottom: 10px;">
          <p class="text-muted" style="margin: 0; font-size: 14px;">
            <i class="bi bi-tag"></i> <strong>Tags:</strong>
            {% for tag in tags %}
            <a href="{{SITEURL}}/tags/{{ tag.name }}" class="badge bg-secondary text-decoration-none" style="margin-left: 5px; margin-bottom: 3px;">{{ tag.name }}</a>
            {% endfor %}
          </p>
        </div>
        {% endif %}
        {% if current_user.is_authenticated %}
        <div class="btn-group btn-group-sm">
          {% if can_edit %}
          <button type="button" class="btn btn-link" data-bs-toggle="modal" data-bs-target="#privacyModal" title="Privacy">
            <i class="bi bi-lock"></i>
            {% if photo.privacy == 0 or photo.privacy is none %}
            <span class="text-success">public</span>
            {% elif photo.privacy == 1 %}
            <span class="text-info">friends</span>
            {% elif photo.privacy == 2 %}
            <span class="text-warning">family</span>
            {% elif photo.privacy == 3 %}
            <span class="text-danger">private</span>
            {% endif %}
          </button>
          <button type="button" class="btn btn-link" data-bs-toggle="modal" data-bs-target="#tagsModal" title="Edit Tags">
            <i class="bi bi-tag"></i> edit
          </button>
          <a href="{{SITEURL}}/photos/{{ photo.id }}/original" class="btn btn-link" target="_blank" title="View Original">
            <i class="bi bi-image"></i> original
          </a>
          {% endif %}
          <button type="button" class="btn btn-link" data-bs-toggle="modal" data-bs-target="#shareModal" title="Share">
            <i class="bi bi-share"></i> share
            {% if can_edit %}
            <span class="badge" id="shareCountBadge" style="display: none; background-color: #d9534f;"></span>
            {% endif %}
          </button>
          {% if can_edit %}
          <button type="button" class="btn btn-link text-danger" onclick="deletePhoto({{ photo.id }})" title="Delete">
            <i class="bi bi-trash"></i> delete
          </button>
          {% endif %}
        </div>
        {% endif %}
      </div>
    </div>
    <hr>

    <div class="row">
      <div class="col-md-12">
        <img class='img-fluid' style="width: 100%; max-height: 85vh; object-fit: contain;" src="{{ signed_s3_url(photo.uri, '_b') }}">
      </div>
    </div>

    <!-- Navigation Buttons -->
    {% if prev_photo or next_photo %}
    <div class="row" style="margin-top: 15px;">
      <div class="col-md-12 text-center">
        <div class="btn-group" role="group">
          {% if prev_photo %}
          <a href="{{SITEURL}}/photos/{{ prev_photo.id }}?in={{ in_context }}" class="btn btn-secondary" id="prevPhotoBtn">
            <i class="bi bi-chevron-left"></i> Previous
          </a>
          {% else %}
          <button class="btn btn-secondary" disabled>
            <i class="bi bi-chevron-left"></i> Previous
          </button>
          {% endif %}

          <a href="{{ context_url }}" class="btn btn-primary">
            <i class="bi bi-grid-3x3-gap"></i> Back to {{ context_name }}
          </a>

          {% if next_photo %}
          <a href="{{SITEURL}}/photos/{{ next_photo.id }}?in={{ in_context }}" class="btn btn-secondary" id="nextPhotoBtn">
            Next <i class="bi bi-chevron-right"></i>
          </a>
          {% else %}
          <button class="btn btn-secondary" disabled>
            Next <i class="bi bi-chevron-right"></i>
          </button>
          {% endif %}
        </div>
      </div>
    </div>
    {% endif %}

      {% if current_user.is_authenticated %}
      <!-- Share Modal -->
      <div class="modal fade" id="shareModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <form method="POST" action="{{SITEURL}}/photos/{{ photo.id }}/share?in={{ in_context }}">
              <div class="modal-header">
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                <h4 class="modal-title">Create Share Link</h4>
              </div>
              <div class="modal-body">
                <p>Create a secure link to share this photo with others.</p>

                <div class="form-group">
                  <label for="comment">Comment / Note</label>
                  <textarea name="comment" id="comment" class="form-control" rows="2" placeholder="Optional note about this share (e.g., who it's for, why it was created)"></textarea>
                  <small class="text-muted">This note is for your reference only.</small>
                </div>

                <div class="form-group">
                  <label for="days">Expiration</label>
                  <select name="days" id="days" class="form-control">
                    <option value="1">1 day</option>
                    <option value="7">7 days</option>
                    <option value="30" selected>30 days</option>
                    <option value="90">90 days</option>
                    <option value="365">1 year</option>
                    <option value="0">Never expires</option>
                  </select>
                </div>

                <div class="form-group">
                  <label for="max_views">Max Views</label>
                  <input type="number" name="max_views" id="max_views" class="form-control" min="1" placeholder="Unlimited">
                  <small class="text-muted">Leave blank for unlimited views.</small>
                </div>

                <div class="checkbox">
                  <label>
                    <input type="checkbox" name="allow_download"> Allow downloading original photo
                  </label>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-primary">Create Link</button>
              </div>
            </form>
          </div>
        </div>
      </div>
      {% endif %}

      {% if can_edit %}
      <!-- Privacy Modal -->
      <div class="modal fade" id="privacyModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-sm" role="document">
          <div class="modal-content">
            <form method="POST" action="{{SITEURL}}/photos/{{ photo.id }}/update?in={{ in_context }}">
              <input type="hidden" name="action" value="privacy">
              <div class="modal-header">
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                <h4 class="modal-title">Change Privacy</h4>
              </div>
              <div class="modal-body">
                <div class="form-group">
                  <label for="privacy">Privacy Level</label>
                  <select name="privacy" id="privacy" class="form-control">
                    <option value="0" {% if photo.privacy == 0 or photo.privacy is none %}selected{% endif %}>Public</option>
                    <option value="1" {% if photo.privacy == 1 %}selected{% endif %}>Friends</option>
                    <option value="2" {% if photo.privacy == 2 %}selected{% endif %}>Family</option>
                    <option value="3" {% if photo.privacy == 3 %}selected{% endif %}>Private</option>
                  </select>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-primary">Save</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Tags Modal -->
      <div class="modal fade" id="tagsModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <form method="POST" action="{{SITEURL}}/photos/{{ photo.id }}/update?in={{ in_context }}">
              <input type="hidden" name="action" value="tags">
              <div class="modal-header">
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                <h4 class="modal-title">Edit Tags</h4>
              </div>
              <div class="modal-body">
                <div class="form-group">
                  <label for="tags">Tags (space-separated)</label>
                  <input type="text" name="tags" id="tags" class="form-control"
                         value="{% for tag in tags %}{{ tag.name }}{% if not loop.last %} {% endif %}{% endfor %}">
                  <p class="help-block">Enter tags separated by spaces (e.g., vacation beach summer)</p>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-primary">Save</button>
              </div>
            </form>
          </div>
        </div>
      </div>
      {% endif %}

      <!-- Keyboard Shortcuts Help Modal -->
      <div class="modal fade" id="keyboardHelpModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              <h4 class="modal-title"><i class="bi bi-keyboard"></i> Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <h5>Navigation</h5>
              <dl class="dl-horizontal">
                <dt><kbd>‚Üê</kbd></dt><dd>Previous photo</dd>
                <dt><kbd>‚Üí</kbd></dt><dd>Next photo</dd>
                <dt><kbd>‚Üë</kbd></dt><dd>Back to {{ context_name|default('context') }}</dd>
              </dl>

              {% if current_user.is_authenticated and can_edit %}
              <h5>Photo Actions</h5>
              <dl class="dl-horizontal">
                <dt><kbd>t</kbd></dt><dd>Edit tags</dd>
                <dt><kbd>p</kbd></dt><dd>Change privacy</dd>
                <dt><kbd>s</kbd></dt><dd>Share photo</dd>
                <dt><kbd>o</kbd></dt><dd>View original</dd>
                <dt><kbd>Del</kbd></dt><dd>Delete photo</dd>
              </dl>
              {% endif %}

              <h5>General</h5>
              <dl class="dl-horizontal">
                <dt><kbd>?</kbd></dt><dd>Show this help</dd>
                <dt><kbd>Esc</kbd></dt><dd>Close modals</dd>
              </dl>

              <p class="text-muted"><small><em>Tip: Hold Alt/Cmd/Ctrl with arrow keys for browser navigation</em></small></p>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
  <br><br>
  {% endif %}

<!-- JavaScript Section (flat structure, outside POW conditional) -->
{% if has_pow or not config['POW_SPLIT_BRAIN_PHOTOS'] %}
  <!-- Lazy loading for images -->
  <script src="{{SITEURL}}/static/js/lazy-loading.js"></script>

  {% if current_user.is_authenticated and can_edit %}
  <!-- Editor utilities -->
  <script src="{{SITEURL}}/static/js/editor.js"></script>
  <script>
  // Admin-only functions
  function deletePhoto(photoId) {
    if (confirm('Are you sure you want to delete this photo? This cannot be undone.')) {
      window.location.href = '{{SITEURL}}/photos/' + photoId + '/delete';
    }
  }

  // Load share count on page load
  CigarboxEditor.loadShareCount(
    '{{SITEURL}}/photos/{{ photo.id }}/shares',
    'shareCountBadge',
    '{{SITEURL}}/admin/shares?search={{ photo.id }}'
  );
  </script>
  {% endif %}

  <script>
  // Keyboard shortcuts for photo page (navigation available to all)
  document.addEventListener('keydown', function(e) {
    // Ignore if user is typing in an input field
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
      return;
    }

    // Ignore if any modal is currently open (except for Escape key to close)
    if (e.key !== 'Escape') {
      var modalOpen = document.querySelector('.modal.show') !== null;
      if (modalOpen) {
        return;
      }
    }

    // Ignore if modifier keys are pressed (Alt/Cmd/Ctrl for browser navigation)
    if (e.altKey || e.metaKey || e.ctrlKey) {
      return;
    }

    // Arrow key navigation (left/right for photos, up for back)
    // Also supports vim-style: j=prev, l=next, i=up
    if (e.key === 'ArrowLeft' || e.key === 'j' || e.key === 'J') {
      var prevBtn = document.getElementById('prevPhotoBtn');
      if (prevBtn) {
        e.preventDefault();
        window.location.href = prevBtn.href;
      }
    } else if (e.key === 'ArrowRight' || e.key === 'l' || e.key === 'L') {
      var nextBtn = document.getElementById('nextPhotoBtn');
      if (nextBtn) {
        e.preventDefault();
        window.location.href = nextBtn.href;
      }
    } else if (e.key === 'ArrowUp' || e.key === 'i' || e.key === 'I') {
      // Back to context (works for all users)
      var backBtn = document.querySelector('a.btn-primary[href="{{ context_url }}"]');
      if (backBtn) {
        e.preventDefault();
        window.location.href = backBtn.href;
      }
    }
    {% if current_user.is_authenticated %}
    // Share shortcut (all authenticated users)
    else if (e.key === 's' || e.key === 'S') {
      e.preventDefault();
      $('#shareModal').modal('show');
    }
    {% endif %}
    {% if current_user.is_authenticated and can_edit %}
    // Edit shortcuts (editors only)
    else if (e.key === 't' || e.key === 'T') {
      e.preventDefault();
      $('#tagsModal').modal('show');
    } else if (e.key === 'p' || e.key === 'P') {
      e.preventDefault();
      $('#privacyModal').modal('show');
    } else if (e.key === 'o' || e.key === 'O') {
      e.preventDefault();
      window.open('{{SITEURL}}/photos/{{ photo.id }}/original', '_blank');
    } else if (e.key === 'Delete' || e.key === 'Backspace') {
      e.preventDefault();
      deletePhoto({{ photo.id }});
    }
    {% endif %}
    else if (e.key === '?') {
      e.preventDefault();
      $('#keyboardHelpModal').modal('show');
    } else if (e.key === 'Escape') {
      // Close any open modals
      $('.modal').modal('hide');
    }
  });

  // Auto-focus and keyboard shortcuts for modals
  {% if current_user.is_authenticated and can_edit %}
  // Tags and Privacy modals (editors only)
  $('#tagsModal').on('shown.bs.modal', function() {
    $('#tags').focus();
  });
  $('#privacyModal').on('shown.bs.modal', function() {
    $('#privacy').focus();
  });

  // Submit tags/privacy forms with Enter key
  $('#tagsModal input, #privacyModal select').on('keydown', function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      $(this).closest('form').submit();
    }
  });
  {% endif %}

  {% if current_user.is_authenticated %}
  // Share modal (all authenticated users)
  $('#shareModal input[type="text"], #shareModal input[type="number"], #shareModal textarea').on('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      $(this).closest('form').submit();
    }
  });
  {% endif %}
  </script>

  {% if current_user.is_authenticated and can_edit %}
  <!-- Tag autocomplete -->
  <script src="{{SITEURL}}/static/js/tag-autocomplete.js"></script>
  <script>
  // Initialize tag autocomplete
  var allTags = [{% for tag in all_tags %}'{{ tag.name|replace("'", "\\'") }}'{% if not loop.last %}, {% endif %}{% endfor %}];
  var tagAutocomplete = initTagAutocomplete('#tags', allTags);

  // Focus input when tags modal opens
  $('#tagsModal').on('shown.bs.modal', function() {
    if (tagAutocomplete && tagAutocomplete.focus) {
      tagAutocomplete.focus();
    }
  });
  </script>
  {% endif %}
  {% endif %}
{% endblock %}