{% extends "layout.html" %}
{% from "_pagination.html" import render_pagination %}
{% block body %}

<!-- Share Link Success Alert -->
{% if session.share_link %}
<div class="row">
  <div class="col-md-12">
    <div class="alert alert-success alert-dismissible" role="alert">
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      <h4><span class="bi bi-check-circle"></span> Photoset Share Link Created!</h4>
      <p>Copy this link to share this photoset:</p>
      <div class="input-group">
        <input type="text" class="form-control" value="{{ session.share_link }}" id="shareUrlInput" readonly>
        <span class="input-group-btn">
          <button class="btn btn-primary" type="button" onclick="copyShareLink()">
            <span class="bi bi-clipboard"></span> Copy
          </button>
        </span>
      </div>
      <p class="help-block" style="margin-top: 10px;">
        {% if session.share_expires and session.share_expires > 0 %}
        This link will expire in {{ session.share_expires }} days.
        {% else %}
        This link never expires.
        {% endif %}
      </p>
    </div>
  </div>
</div>
{% set _ = session.pop('share_link', None) %}
{% set _ = session.pop('share_expires', None) %}
{% endif %}

<div class="row">
  <div class="col-md-8">
    <h1>
      {{ photoset.title }}
      {% if privacy_label %}
      <span class="badge bg-info" style="font-size: 0.5em; vertical-align: middle;">{{ privacy_label }}</span>
      {% endif %}
    </h1>
    {% if photoset.description %}
    <p class="lead">{{photoset.description}}</p>
    {% endif %}
    {% if date_range %}
    <p class="text-muted" style="font-size: 16px; margin-top: -10px; margin-bottom: 5px;">
      <span class="bi bi-calendar"></span> {{ date_range }}
    </p>
    {% endif %}
  </div>
  <div class="col-md-4 text-end">
    {% if unique_tags %}
    <p class="text-muted">
      {% for tag in unique_tags %}
      <a href="{{SITEURL}}/tags/{{ tag.name }}" class="badge bg-secondary">{{ tag.name }}</a>
      {% endfor %}
    </p>
    {% endif %}
    {% if can_manage %}
    <div class="btn-group btn-group-sm">
      <button type="button" class="btn btn-link" data-bs-toggle="modal" data-bs-target="#editPhotosetModal">
        <span class="bi bi-pencil-fill"></span> edit
      </button>
      <button type="button" class="btn btn-link" data-bs-toggle="modal" data-bs-target="#sharePhotosetModal" id="sharePhotosetBtn">
        <span class="bi bi-share"></span> share
        <span class="badge" id="shareCountBadge" style="display: none; background-color: #d9534f;"></span>
      </button>
      <button type="button" class="btn btn-link" onclick="toggleSelectMode()">
        <span class="bi bi-check2-square"></span> select
      </button>
      <a href="{{SITEURL}}/photos/bulk-edit?ids={{ photo_ids }}" class="btn btn-link" id="bulkEditBtn">
        <span class="bi bi-grid-3x3-gap"></span> bulk edit
      </a>
    </div>
    <div id="selectionControls" style="display: none;">
      <button type="button" class="btn btn-sm btn-danger" onclick="removeSelected()">
        <span class="bi bi-x-lg"></span> Remove Selected
      </button>
      <button type="button" class="btn btn-sm btn-secondary" onclick="toggleSelectMode()">
        Cancel
      </button>
    </div>
    {% endif %}
  </div>
</div>
<hr>


<div class="justified-gallery" id="photo-grid">
  {% for photo in photos %}
  <div class="jg-item-wrapper" style="display: inline-block; position: relative;">
    {% if can_manage %}
    <div class="photo-checkbox" style="display: none; position: absolute; top: 10px; left: 10px; z-index: 10;">
      <input type="checkbox" name="photo_ids" value="{{ photo.id }}" style="transform: scale(2);">
    </div>
    {% endif %}
    <a href="{{SITEURL}}/photos/{{ photo.id }}?in={{ in_context }}" class="jg-item">
      <img class="lazy jg-photo"
           data-src="http://s3.amazonaws.com/{{ config['S3_BUCKET_NAME'] }}/{{ photo.uri }}_c.jpg"
           src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='320' height='240'%3E%3Crect fill='%23eee' width='320' height='240'/%3E%3C/svg%3E"
           alt="Photo {{ photo.id }}">
    </a>
    {% if current_user.is_authenticated and photo.privacy and photo.privacy > 0 %}
    <span class="privacy-corner-badge" title="{% if photo.privacy == 1 %}Friends only{% elif photo.privacy == 2 %}Family{% elif photo.privacy == 3 %}Private{% endif %}">
      {% if photo.privacy == 1 %}üë•{% elif photo.privacy == 2 %}üë®‚Äçüë©‚Äçüëß{% elif photo.privacy == 3 %}üîí{% endif %}
    </span>
    {% endif %}
  </div>
  {% else %}
  <p class="text-muted">You should really take more photos.</p>
  {% endfor %}
</div>


<!-- Pagination -->
{{ render_pagination(pagination, baseurl) }}

{% if can_manage %}
<!-- Share Photoset Modal -->
<div class="modal fade" id="sharePhotosetModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <form method="POST" action="{{SITEURL}}/photosets/{{ photoset.id }}/share">
        <div class="modal-header">
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          <h4 class="modal-title">Create Photoset Share Link</h4>
        </div>
        <div class="modal-body">
          <p>Create a secure link to share this entire photoset with others.</p>

          <div class="form-group">
            <label for="comment">Comment / Note</label>
            <textarea name="comment" id="comment" class="form-control" rows="2" placeholder="Optional note about this share"></textarea>
            <small class="text-muted">This note is for your reference only.</small>
          </div>

          <div class="form-group">
            <label for="days">Expiration</label>
            <select name="days" id="days" class="form-control">
              <option value="1">1 day</option>
              <option value="7">7 days</option>
              <option value="30" selected>30 days</option>
              <option value="90">90 days</option>
              <option value="365">1 year</option>
              <option value="0">Never expires</option>
            </select>
          </div>

          <div class="form-group">
            <label for="max_views">Max Views</label>
            <input type="number" name="max_views" id="max_views" class="form-control" min="1" placeholder="Unlimited">
            <small class="text-muted">Leave blank for unlimited views.</small>
          </div>

          <div class="checkbox">
            <label>
              <input type="checkbox" name="allow_download"> Allow downloading original photos
            </label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Create Link</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit Photoset Modal -->
<div class="modal fade" id="editPhotosetModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <form method="POST" action="{{SITEURL}}/photosets/{{ photoset.id }}/update">
        <div class="modal-header">
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          <h4 class="modal-title">Edit Photoset</h4>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="title">Title</label>
            <input type="text" name="title" id="title" class="form-control" value="{{ photoset.title }}" required>
          </div>
          <div class="form-group">
            <label for="description">Description</label>
            <textarea name="description" id="description" class="form-control" rows="3">{{ photoset.description if photoset.description else '' }}</textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger float-start" onclick="deletePhotoset()">
            <span class="bi bi-trash-fill"></span> Delete Photoset
          </button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<style>
/* Privacy corner badges */
.privacy-corner-badge {
  position: absolute;
  top: 2px;
  right: 2px;
  background: rgba(255, 255, 255, 0.85);
  padding: 0;
  border-radius: 3px;
  font-size: 10px;
  line-height: 1;
}

[data-bs-theme="dark"] .privacy-corner-badge {
  background: rgba(0, 0, 0, 0.7);
}
</style>

<script>
var selectMode = false;

// Load share count on page load
{% if can_manage %}
function loadShareCount() {
  fetch('{{SITEURL}}/photosets/{{ photoset.id }}/shares')
    .then(response => response.json())
    .then(data => {
      if (data.shares && data.shares.length > 0) {
        var badge = document.getElementById('shareCountBadge');
        badge.textContent = data.shares.length;
        badge.style.display = 'inline';

        // Make badge clickable to go to admin shares page
        badge.style.cursor = 'pointer';
        badge.onclick = function(e) {
          e.stopPropagation(); // Don't trigger the modal
          window.location.href = '{{SITEURL}}/admin/shares?search={{ photoset.id }}';
        };
      }
    })
    .catch(error => {
      console.error('Error loading share count:', error);
    });
}

loadShareCount();
{% endif %}

// Keyboard shortcuts for photoset page
{% if can_manage %}
document.addEventListener('keydown', function(e) {
  // Ignore if user is typing in an input field
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
    return;
  }

  // Ignore if modifier keys are pressed
  if (e.altKey || e.metaKey || e.ctrlKey) {
    return;
  }

  if (e.key === 's' || e.key === 'S') {
    e.preventDefault();
    document.getElementById('sharePhotosetBtn').click();
  } else if (e.key === 'e' || e.key === 'E') {
    e.preventDefault();
    window.location.href = document.getElementById('bulkEditBtn').href;
  }
});
{% endif %}

function deletePhotoset() {
  if (confirm('Delete this photoset? This will NOT delete the photos, only remove the photoset.')) {
    window.location.href = '{{SITEURL}}/photosets/{{ photoset.id }}/delete';
  }
}

function toggleSelectMode() {
  selectMode = !selectMode;
  var checkboxes = document.querySelectorAll('.photo-checkbox');
  var controls = document.getElementById('selectionControls');

  checkboxes.forEach(function(cb) {
    cb.style.display = selectMode ? 'block' : 'none';
  });

  controls.style.display = selectMode ? 'inline' : 'none';

  // Uncheck all when exiting select mode
  if (!selectMode) {
    document.querySelectorAll('input[name="photo_ids"]').forEach(function(cb) {
      cb.checked = false;
    });
  }
}

function removeSelected() {
  var checkboxes = document.querySelectorAll('input[name="photo_ids"]:checked');
  if (checkboxes.length === 0) {
    alert('Please select at least one photo to remove');
    return;
  }

  if (!confirm('Remove ' + checkboxes.length + ' photo(s) from this photoset?')) {
    return;
  }

  var photoIds = Array.from(checkboxes).map(function(cb) { return cb.value; });
  var form = document.createElement('form');
  form.method = 'POST';
  form.action = '{{SITEURL}}/photosets/{{ photoset.id }}/remove-photos';

  photoIds.forEach(function(id) {
    var input = document.createElement('input');
    input.type = 'hidden';
    input.name = 'photo_ids';
    input.value = id;
    form.appendChild(input);
  });

  document.body.appendChild(form);
  form.submit();
}

function copyShareLink() {
  var input = document.getElementById('shareUrlInput');
  input.select();
  input.setSelectionRange(0, 99999); // For mobile

  try {
    document.execCommand('copy');
    var btn = event.target.closest('button');
    var originalText = btn.innerHTML;
    btn.innerHTML = '<span class="bi bi-check"></span> Copied!';
    setTimeout(function() {
      btn.innerHTML = originalText;
    }, 2000);
  } catch (err) {
    alert('Failed to copy. Please copy manually: ' + input.value);
  }
}
</script>
{% endif %}

<script>
// Lazy load images
document.addEventListener('DOMContentLoaded', function() {
  var lazyImages = document.querySelectorAll('img.lazy');

  if ('IntersectionObserver' in window) {
    var imageObserver = new IntersectionObserver(function(entries, observer) {
      entries.forEach(function(entry) {
        if (entry.isIntersecting) {
          var img = entry.target;
          img.src = img.dataset.src;
          img.classList.remove('lazy');
          imageObserver.unobserve(img);
        }
      });
    }, {
      rootMargin: '200px'
    });

    lazyImages.forEach(function(img) {
      imageObserver.observe(img);
    });
  } else {
    // Fallback for older browsers
    lazyImages.forEach(function(img) {
      img.src = img.dataset.src;
    });
  }
});
</script>


<br><br>
{% endblock %}