{% extends "layout.html" %}
{% block body %}

<div class="container-fluid">
  <div class="row">
    <div class="col-md-6">
      <h2>Bulk Photo Editor <small>{{ total_photos }} photos, {{ all_tags|length }} tags loaded</small></h2>
    </div>
    <div class="col-md-6 text-right">
      <form method="GET" action="{{SITEURL}}/photos/bulk-edit" class="form-inline">
        <input type="hidden" name="ids" value="{{ request.args.get('ids', '') }}">
        <div class="form-group">
          <label for="group_by">Group by:</label>
          <select name="group_by" id="group_by" class="form-control input-sm" onchange="this.form.submit()">
            <option value="upload_date" {% if group_by == 'upload_date' %}selected{% endif %}>Upload Date</option>
            <option value="date_taken" {% if group_by == 'date_taken' %}selected{% endif %}>Date Taken</option>
          </select>
        </div>
      </form>
    </div>
  </div>

  <!-- Pagination Top -->
  {% if pagination.total_pages > 1 %}
  <div class="row">
    <div class="col-md-12 text-center">
      <ul class="pagination">
        <li {% if not pagination.has_prev %}class="disabled"{% endif %}>
          <a href="{% if pagination.prev_url %}{{ pagination.prev_url }}{% else %}#{% endif %}">&laquo; Prev</a>
        </li>
        <li class="disabled"><a href="#">Page {{ pagination.page }} of {{ pagination.total_pages }}</a></li>
        <li {% if not pagination.has_next %}class="disabled"{% endif %}>
          <a href="{% if pagination.next_url %}{{ pagination.next_url }}{% else %}#{% endif %}">Next &raquo;</a>
        </li>
      </ul>
      <p class="text-muted">Showing {{ pagination.per_page * (pagination.page - 1) + 1 }}-{{ [pagination.per_page * pagination.page, pagination.total] | min }} of {{ pagination.total }}</p>
    </div>
  </div>
  {% endif %}
  <hr>

  <!-- Bulk Operations Panel -->
  <div class="row">
    <div class="col-md-12">
      <div class="panel panel-primary">
        <div class="panel-heading">
          <h3 class="panel-title">Apply to All Photos</h3>
        </div>
        <div class="panel-body">
          <form method="POST" class="form-horizontal">
            <input type="hidden" name="photo_ids" value="{{ photo_ids }}">

            <div class="form-group">
              <label class="col-sm-2 control-label">Add Tags:</label>
              <div class="col-sm-8">
                <div class="input-group">
                  <input type="text" name="bulk_tags" class="form-control tags-input" placeholder="vacation, beach, summer">
                  <span class="input-group-btn">
                    <button type="submit" name="action" value="bulk_tags_add" class="btn btn-primary">
                      <span class="glyphicon glyphicon-tag"></span> Add to All
                    </button>
                  </span>
                </div>
                <p class="help-block">These tags will be added to all photos (existing tags preserved)</p>
              </div>
            </div>

            <div class="form-group">
              <label class="col-sm-2 control-label">Add to Photoset:</label>
              <div class="col-sm-8">
                <div class="input-group">
                  <select name="bulk_photoset" class="form-control">
                    <option value="">Select photoset...</option>
                    {% for photoset in photosets %}
                    <option value="{{ photoset.id }}">{{ photoset.title }}</option>
                    {% endfor %}
                  </select>
                  <span class="input-group-btn">
                    <button type="submit" name="action" value="bulk_photoset" class="btn btn-primary">
                      <span class="glyphicon glyphicon-folder-open"></span> Add to Set
                    </button>
                  </span>
                </div>
              </div>
            </div>

            <div class="form-group">
              <label class="col-sm-2 control-label">Set Privacy:</label>
              <div class="col-sm-8">
                <div class="input-group">
                  <select name="bulk_privacy" class="form-control">
                    <option value="">Select privacy...</option>
                    <option value="0">Public</option>
                    <option value="1">Friends</option>
                    <option value="2">Family</option>
                    <option value="3">Private</option>
                  </select>
                  <span class="input-group-btn">
                    <button type="submit" name="action" value="bulk_privacy" class="btn btn-primary">
                      <span class="glyphicon glyphicon-lock"></span> Apply to All
                    </button>
                  </span>
                </div>
                <p class="help-block">This will overwrite the privacy level for all photos</p>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Individual Photos Form -->
  <form method="POST" id="individual-photos-form">
    <input type="hidden" name="photo_ids" value="{{ photo_ids }}">

    {% for (date_key, date_label), photos in photo_groups %}
    <!-- Group Header (repeated for visual grouping) -->
    <div class="row">
      <div class="col-md-10">
        <h4>
          <span class="glyphicon glyphicon-calendar"></span>
          {% if group_by == 'date_taken' %}
          Date Taken: {{ date_label }}
          {% else %}
          Upload Date: {{ date_label }}
          {% endif %}
          <small class="text-muted">({{ photos|length }} photos)</small>
        </h4>
      </div>
      <div class="col-md-2 text-right">
        <a href="{{SITEURL}}/photos/bulk-edit?ids={% for photo in photos %}{{ photo.id }}{% if not loop.last %},{% endif %}{% endfor %}&group_by={{ group_by }}"
           class="btn btn-sm btn-link"
           style="margin-top: 10px;">
          <span class="glyphicon glyphicon-edit"></span> Just this group
        </a>
      </div>
    </div>

    <!-- Photo Grid -->
    <div class="row">
      {% if photos %}
      {% for photo in photos %}
      <div class="col-xs-6 col-sm-4 col-md-3 col-lg-2">
        <div class="thumbnail">
          <a href="{{SITEURL}}/photos/{{ photo.id }}" target="_blank">
            <img class="lazy" data-src="http://s3.amazonaws.com/{{ config['S3_BUCKET_NAME'] }}/{{ photo.uri }}_m.jpg" alt="Photo {{ photo.id }}" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='240' height='240'%3E%3Crect fill='%23eee' width='240' height='240'/%3E%3C/svg%3E">
          </a>
          <div class="caption">
            <p class="text-center"><small><strong>#{{ photo.id }}</strong></small></p>

            {% if photo.can_edit %}
            <!-- Privacy Dropdown -->
            <select name="privacy_{{ photo.id }}" class="form-control input-sm"
                    data-photo-id="{{ photo.id }}"
                    data-field="privacy"
                    data-original-value="{% if photo.privacy is none %}0{% else %}{{ photo.privacy }}{% endif %}">
              <option value="0" {% if photo.privacy == 0 or photo.privacy is none %}selected{% endif %}>Public</option>
              <option value="1" {% if photo.privacy == 1 %}selected{% endif %}>Friends</option>
              <option value="2" {% if photo.privacy == 2 %}selected{% endif %}>Family</option>
              <option value="3" {% if photo.privacy == 3 %}selected{% endif %}>Private</option>
            </select>

            <!-- Tags Input -->
            <textarea name="tags_{{ photo.id }}" class="form-control input-sm tags-input"
                      placeholder="tags"
                      data-photo-id="{{ photo.id }}"
                      data-field="tags"
                      data-original-value="{% for tag in photo.tag_list %}{{ tag.name }}{% if not loop.last %}, {% endif %}{% endfor %}"
                      style="margin-top: 5px; height: 60px; resize: vertical;">{% for tag in photo.tag_list %}{{ tag.name }}{% if not loop.last %}, {% endif %}{% endfor %}</textarea>
            {% else %}
            <p class="text-muted text-center"><small>View only</small></p>
            {% endif %}
          </div>
        </div>
      </div>
      {% endfor %}
      {% else %}
      <div class="col-md-12">
        <p class="text-muted">No photos in this group (this shouldn't happen - count was {{ photos|length }})</p>
      </div>
      {% endif %}
    </div>
    <br>
    {% endfor %}

    <!-- Save Buttons -->
    <div class="row">
      <div class="col-md-12">
        <div class="well">
          <button type="submit" name="action" value="individual_privacy" class="btn btn-lg btn-primary">
            <span class="glyphicon glyphicon-lock"></span> Save Privacy Changes
          </button>
          <button type="submit" name="action" value="individual_tags" class="btn btn-lg btn-success">
            <span class="glyphicon glyphicon-tag"></span> Save Tag Changes
          </button>
          <a href="{{SITEURL}}/photostream" class="btn btn-lg btn-default">
            <span class="glyphicon glyphicon-remove"></span> Cancel
          </a>
        </div>
      </div>
    </div>
  </form>

  <!-- Pagination Bottom -->
  {% if pagination.total_pages > 1 %}
  <div class="row">
    <div class="col-md-12 text-center">
      <ul class="pagination">
        <li {% if not pagination.has_prev %}class="disabled"{% endif %}>
          <a href="{% if pagination.prev_url %}{{ pagination.prev_url }}{% else %}#{% endif %}">&laquo; Prev</a>
        </li>
        <li class="disabled"><a href="#">Page {{ pagination.page }} of {{ pagination.total_pages }}</a></li>
        <li {% if not pagination.has_next %}class="disabled"{% endif %}>
          <a href="{% if pagination.next_url %}{{ pagination.next_url }}{% else %}#{% endif %}">Next &raquo;</a>
        </li>
      </ul>
    </div>
  </div>
  {% endif %}

</div>

<style>
.alert-fixed {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 9999;
  min-width: 300px;
  animation: slideIn 0.3s ease-out;
}
@keyframes slideIn {
  from { transform: translateX(400px); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}
</style>

<div id="alert-container"></div>

<script>
// Show alert message
function showAlert(message, type) {
  type = type || 'success';
  var alertContainer = document.getElementById('alert-container');
  var alertDiv = document.createElement('div');
  alertDiv.className = 'alert alert-' + type + ' alert-dismissible alert-fixed';
  alertDiv.innerHTML = '<button type="button" class="close" data-dismiss="alert">&times;</button>' + message;
  alertContainer.appendChild(alertDiv);

  // Auto-dismiss after 5 seconds
  setTimeout(function() {
    alertDiv.style.opacity = '0';
    setTimeout(function() {
      alertDiv.remove();
    }, 300);
  }, 5000);
}

// Track which photos have been changed
var changedPhotos = new Set();

// Track which button was clicked for form submission
var lastClickedButton = null;

// Mark photo as changed when fields are modified
function markPhotoChanged(photoId) {
  changedPhotos.add(photoId);
  console.log('Photo', photoId, 'marked as changed. Total changed:', changedPhotos.size);
}

// AJAX form submission
function submitFormAjax(form, event) {
  if (event) event.preventDefault();

  // Get the action from the clicked button (captured in click handler)
  var action = null;
  if (lastClickedButton && lastClickedButton.name === 'action') {
    action = lastClickedButton.value;
  }

  // If no button was clicked, check if Enter was pressed in a tags/privacy field
  if (!action) {
    var activeElement = document.activeElement;
    if (activeElement && activeElement.name) {
      if (activeElement.name.startsWith('tags_') || activeElement.name.startsWith('privacy_')) {
        action = 'individual_both';
      }
    }
  }

  console.log('Submit triggered, action:', action);

  // For individual photo updates, only send changed photos
  if (action === 'individual_privacy' || action === 'individual_tags' || action === 'individual_both') {
    if (changedPhotos.size === 0) {
      showAlert('No changes to save', 'info');
      return false;
    }

    var formData = new FormData();
    formData.set('action', action);

    // Build comma-separated list of changed photo IDs
    var changedIds = Array.from(changedPhotos).join(',');
    formData.set('photo_ids', changedIds);

    // Only include fields for changed photos
    changedPhotos.forEach(function(photoId) {
      if (action === 'individual_privacy') {
        var privacyField = form.querySelector('[name="privacy_' + photoId + '"]');
        if (privacyField) {
          formData.set('privacy_' + photoId, privacyField.value);
        }
      } else if (action === 'individual_tags') {
        var tagsField = form.querySelector('[name="tags_' + photoId + '"]');
        if (tagsField) {
          formData.set('tags_' + photoId, tagsField.value);
        }
      } else if (action === 'individual_both') {
        // Save both privacy and tags
        var privacyField = form.querySelector('[name="privacy_' + photoId + '"]');
        if (privacyField) {
          formData.set('privacy_' + photoId, privacyField.value);
        }
        var tagsField = form.querySelector('[name="tags_' + photoId + '"]');
        if (tagsField) {
          formData.set('tags_' + photoId, tagsField.value);
        }
      }
    });

    console.log('Submitting', changedPhotos.size, 'changed photos');
  } else {
    // Bulk operations - submit entire form as-is
    var formData = new FormData(form);
    if (action) {
      formData.set('action', action);
    }
  }

  // Get the action URL
  var actionUrl = (typeof form.action === 'string') ? form.action : window.location.href;

  fetch(actionUrl, {
    method: 'POST',
    body: formData,
    headers: {
      'X-Requested-With': 'XMLHttpRequest'
    }
  })
  .then(function(response) {
    if (!response.ok) {
      throw new Error('HTTP ' + response.status);
    }
    return response.json();
  })
  .then(function(data) {
    console.log('AJAX response received:', data);
    if (data.success) {
      console.log('Success message:', data.message);
      showAlert(data.message || 'Changes saved successfully', 'success');

      // Clear changed photos on successful save
      if (action === 'individual_privacy' || action === 'individual_tags' || action === 'individual_both') {
        // Update original values for saved photos
        changedPhotos.forEach(function(photoId) {
          var privacyField = form.querySelector('[name="privacy_' + photoId + '"]');
          if (privacyField) {
            privacyField.setAttribute('data-original-value', privacyField.value);
          }
          var tagsField = form.querySelector('[name="tags_' + photoId + '"]');
          if (tagsField) {
            tagsField.setAttribute('data-original-value', tagsField.value);
          }
        });
        changedPhotos.clear();
        console.log('Changes saved and cleared');
      }
    } else {
      showAlert(data.message || 'Error processing request', 'danger');
    }
  })
  .catch(function(error) {
    console.error('AJAX error:', error);
    showAlert('Network error: ' + error, 'danger');
  });

  return false;
}

// Lazy load images
document.addEventListener('DOMContentLoaded', function() {
  var lazyImages = document.querySelectorAll('img.lazy');

  if ('IntersectionObserver' in window) {
    var imageObserver = new IntersectionObserver(function(entries, observer) {
      entries.forEach(function(entry) {
        if (entry.isIntersecting) {
          var img = entry.target;
          img.src = img.dataset.src;
          img.classList.remove('lazy');
          imageObserver.unobserve(img);
        }
      });
    }, {
      rootMargin: '200px'  // Start loading 200px before entering viewport
    });

    lazyImages.forEach(function(img) {
      imageObserver.observe(img);
    });
  } else {
    // Fallback for older browsers
    lazyImages.forEach(function(img) {
      img.src = img.dataset.src;
    });
  }

  // Attach change listeners to track modifications
  var photoFields = document.querySelectorAll('[data-photo-id][data-field]');
  console.log('Found', photoFields.length, 'photo fields to track');

  function checkFieldChanged(field) {
    var photoId = field.getAttribute('data-photo-id');
    var originalValue = field.getAttribute('data-original-value');
    var currentValue = field.value;

    if (currentValue !== originalValue) {
      markPhotoChanged(photoId);
    } else {
      // Remove from changed set if value matches original (e.g., after save or undo)
      changedPhotos.delete(photoId);
      console.log('Photo', photoId, 'removed from changed set (matches original). Total changed:', changedPhotos.size);
    }
  }

  photoFields.forEach(function(field) {
    // Check on change (when field loses focus)
    field.addEventListener('change', function() {
      checkFieldChanged(this);
    });
    // Also check on input (while typing) for more responsive tracking
    field.addEventListener('input', function() {
      checkFieldChanged(this);
    });
  });

  // Capture which button was clicked for form submission
  document.addEventListener('click', function(e) {
    if (e.target.tagName === 'BUTTON' && e.target.type === 'submit') {
      lastClickedButton = e.target;
      console.log('Button clicked:', e.target.name, '=', e.target.value);
    }
  }, true);

  // Attach AJAX handlers to all forms
  var forms = document.querySelectorAll('form[method="POST"]');
  console.log('Found', forms.length, 'POST forms to attach AJAX handlers');
  forms.forEach(function(form) {
    form.addEventListener('submit', function(event) {
      console.log('Form submit event triggered');
      submitFormAjax(form, event);
    });
  });

  // Tag autocomplete with inline suggestion
  var allTags = [{% for tag in all_tags %}'{{ tag.name|replace("'", "\\'") }}'{% if not loop.last %}, {% endif %}{% endfor %}];

  // Create suggestion containers for each tag input
  var tagInputs = document.querySelectorAll('.tags-input');
  console.log('Found', tagInputs.length, 'tag inputs for autocomplete');

  tagInputs.forEach(function(input) {
    // Wrap input in a container for positioning the dropdown
    var wrapper = document.createElement('div');
    wrapper.style.position = 'relative';
    wrapper.style.display = 'block';
    wrapper.style.width = '100%';
    input.parentNode.insertBefore(wrapper, input);
    wrapper.appendChild(input);

    // Create suggestion dropdown
    var dropdown = document.createElement('div');
    dropdown.style.position = 'absolute';
    dropdown.style.top = '100%';
    dropdown.style.left = '0';
    dropdown.style.right = '0';
    dropdown.style.background = '#f9f9f9';
    dropdown.style.border = '1px solid #ccc';
    dropdown.style.borderTop = 'none';
    dropdown.style.maxHeight = '150px';
    dropdown.style.overflowY = 'auto';
    dropdown.style.zIndex = '1000';
    dropdown.style.display = 'none';
    dropdown.style.fontSize = '12px';
    wrapper.appendChild(dropdown);

    var currentSuggestion = null;

    function updateSuggestion() {
      var value = input.value;
      var lastComma = value.lastIndexOf(',');
      var currentWord = lastComma >= 0 ? value.substring(lastComma + 1).trim() : value.trim();

      if (currentWord.length > 0) {
        // Find matching tags
        var matches = allTags.filter(function(tag) {
          return tag.toLowerCase().startsWith(currentWord.toLowerCase());
        });

        if (matches.length > 0) {
          currentSuggestion = matches[0];
          // Show first match in dropdown
          dropdown.innerHTML = '<div style="padding: 4px 8px; color: #666;"><strong>' + currentWord + '</strong>' + matches[0].substring(currentWord.length) + ' <span style="color: #999;">(space to accept)</span></div>';
          dropdown.style.display = 'block';
        } else {
          currentSuggestion = null;
          dropdown.style.display = 'none';
        }
      } else {
        currentSuggestion = null;
        dropdown.style.display = 'none';
      }
    }

    input.addEventListener('input', updateSuggestion);
    input.addEventListener('blur', function() {
      // Hide dropdown after a short delay (allows clicking)
      setTimeout(function() {
        dropdown.style.display = 'none';
      }, 200);
    });

    // Move cursor to end when focusing
    input.addEventListener('focus', function() {
      var len = this.value.length;
      this.setSelectionRange(len, len);
    });

    input.addEventListener('keydown', function(e) {
      // Enter key submits (saves both tags and privacy)
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        var form = input.closest('form');
        if (form) {
          // Set action to save both
          var fakeButton = document.createElement('button');
          fakeButton.name = 'action';
          fakeButton.value = 'individual_both';
          fakeButton.style.display = 'none';
          form.appendChild(fakeButton);

          // Trigger the form submission
          submitFormAjax(form, e);

          form.removeChild(fakeButton);
        }
      }
      // Space accepts the suggestion
      else if (e.key === ' ' && currentSuggestion) {
        e.preventDefault();
        var value = input.value;
        var lastComma = value.lastIndexOf(',');
        if (lastComma >= 0) {
          input.value = value.substring(0, lastComma + 1) + ' ' + currentSuggestion + ', ';
        } else {
          input.value = currentSuggestion + ', ';
        }
        currentSuggestion = null;
        dropdown.style.display = 'none';
        // Trigger change tracking
        checkFieldChanged(input);
      }
    });
  });
});
</script>

{% endblock %}
